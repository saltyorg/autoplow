{{define "content"}}
<div class="space-y-6">
    {{if .Content.IsNew}}
    <!-- New Trigger Form -->
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">New Trigger</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Create a new webhook trigger for media scanning.</p>
        </div>
    </div>

    <form action="/triggers" method="POST" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 space-y-6" onsubmit="return validatePathRewrites('path-rewrites-list')">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                <input type="text" name="name" id="name" required
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                    placeholder="Sonarr TV Shows">
            </div>
            <div>
                <label for="type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                <select name="type" id="type" required
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <option value="sonarr">Sonarr</option>
                    <option value="radarr">Radarr</option>
                    <option value="lidarr">Lidarr</option>
                    <option value="webhook">Webhook (Generic)</option>
                    <option value="autoplow">Autoplow (Instance-to-Instance)</option>
                    <option value="a_train">A-Train (Google Drive)</option>
                    <option value="autoscan">Autoscan (Compatibility)</option>
                    <option value="inotify">Inotify (File Watch)</option>
                    <option value="polling">Polling (Directory Scanner)</option>
                </select>
            </div>
            <div>
                <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                <input type="text" inputmode="numeric" name="priority" id="priority" value="0"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Higher priority triggers are processed first</p>
            </div>
            <div class="flex items-center pt-6">
                <input type="checkbox" name="enabled" id="enabled" checked
                    class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                <label for="enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Enabled</label>
            </div>
        </div>

        <!-- Inotify-specific fields -->
        <div id="inotify-fields" class="hidden space-y-6 border-t border-gray-200 dark:border-gray-700 pt-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Watch Paths</label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Directories to monitor for file changes</p>
                <div id="watch-paths-list" class="space-y-2">
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <button type="button" onclick="addWatchPath()" class="mt-2 inline-flex items-center text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Watch Path
                </button>
            </div>
            <div>
                <label for="debounce_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Debounce Delay (seconds)</label>
                <input type="text" inputmode="numeric" name="debounce_seconds" id="debounce_seconds" value="5"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Wait time after file activity before triggering a scan (prevents duplicate scans)</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Actions</label>
                <div class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-3">
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_enabled" id="scan_enabled_inotify" checked
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_enabled_inotify" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger scans</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="upload_enabled" id="upload_enabled_inotify" checked
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="upload_enabled_inotify" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger uploads</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_existing_on_start" id="scan_existing_on_start"
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_existing_on_start" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Scan existing files on start</label>
                    </div>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Startup scans respect the scan/upload toggles above.</p>
            </div>
        </div>

        <!-- Polling-specific fields -->
        <div id="polling-fields" class="hidden space-y-6 border-t border-gray-200 dark:border-gray-700 pt-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Watch Paths</label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Directories to scan periodically for new files</p>
                <div id="polling-watch-paths-list" class="space-y-2">
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                <button type="button" onclick="addPollingWatchPath()" class="mt-2 inline-flex items-center text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Watch Path
                </button>
            </div>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="poll_interval_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Poll Interval (seconds)</label>
                    <input type="text" inputmode="numeric" name="poll_interval_seconds" id="poll_interval_seconds" value="60"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to scan directories for new files (minimum 10 seconds)</p>
                </div>
                <div class="flex items-center pt-6">
                    <input type="checkbox" name="queue_existing_on_start" id="queue_existing_on_start" checked
                        class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="queue_existing_on_start" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Queue existing files on start</label>
                    <p class="ml-2 text-xs text-gray-500 dark:text-gray-400">(Default: queue all files on first poll)</p>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Actions</label>
                <div class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_enabled" id="scan_enabled_polling" checked
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_enabled_polling" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger scans</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="upload_enabled" id="upload_enabled_polling" checked
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="upload_enabled_polling" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger uploads</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Authentication Settings (for webhook triggers only) -->
        <div id="auth-fields" class="hidden space-y-6 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white">Authentication</h4>
            <p class="text-xs text-gray-500 dark:text-gray-400">Choose how this trigger will authenticate incoming webhook requests.</p>

            <div class="space-y-4">
                <div class="flex items-center">
                    <input type="radio" name="auth_type" id="auth_type_api_key" value="api_key" checked
                        class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="auth_type_api_key" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                        API Key (recommended)
                    </label>
                </div>
                <p class="ml-7 text-xs text-gray-500 dark:text-gray-400">A secure random API key will be generated. Pass it via the <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">X-API-Key</code> header (recommended) or as a query parameter.</p>

                <div class="flex items-center">
                    <input type="radio" name="auth_type" id="auth_type_basic" value="basic"
                        class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="auth_type_basic" class="ml-3 block text-sm font-medium text-gray-700 dark:text-gray-300">
                        Username/Password (HTTP Basic Auth)
                    </label>
                </div>
                <p class="ml-7 text-xs text-gray-500 dark:text-gray-400">Use HTTP Basic Authentication with a custom username and password.</p>

                <!-- Basic auth credentials fields -->
                <div id="basic-auth-fields" class="hidden ml-7 mt-4 space-y-4">
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                        <div>
                            <label for="trigger_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Username</label>
                            <input type="text" name="trigger_username" id="trigger_username"
                                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                                placeholder="webhook_user">
                        </div>
                        <div>
                            <label for="trigger_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                            <input type="password" name="trigger_password" id="trigger_password"
                                class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                                placeholder="Enter a secure password">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Path Rewrites Section -->
        <div id="path-rewrites-section" class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <div>
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Path Rewrites (Optional)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Translate incoming paths. Use simple prefix replacement or regex with capture groups ($1, $2, etc.)</p>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="addPathRewrite(false)" class="btn-secondary text-xs">
                            Add Simple
                        </button>
                        <button type="button" onclick="addPathRewrite(true)" class="btn-secondary text-xs">
                            Add Regex
                        </button>
                    </div>
                </div>
                <div id="path-rewrites-list" class="space-y-2">
                    <!-- Path rewrites will be added here dynamically -->
                </div>
            </div>
        </div>

        <!-- Path Filters Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Path Filters (Optional)</h4>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Filter which paths this trigger will accept. Include paths are checked first (if any specified, path must match at least one). Exclude paths are then checked (path matching any will be rejected).</p>

            <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Include Paths -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Include Paths</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Only accept paths starting with these prefixes (leave empty to accept all)</p>
                        </div>
                        <button type="button" onclick="addIncludePath()" class="btn-secondary text-xs">
                            Add
                        </button>
                    </div>
                    <div id="include-paths-list" class="space-y-2">
                        <!-- Include paths will be added here dynamically -->
                    </div>
                </div>

                <!-- Exclude Paths -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Paths</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reject paths starting with these prefixes</p>
                        </div>
                        <button type="button" onclick="addExcludePath()" class="btn-secondary text-xs">
                            Add
                        </button>
                    </div>
                    <div id="exclude-paths-list" class="space-y-2">
                        <!-- Exclude paths will be added here dynamically -->
                    </div>
                </div>
            </div>

            <!-- Filter Timing Toggle (for webhook triggers only) -->
            <div id="filter-timing-toggle" class="mt-4 hidden">
                <div class="flex items-center">
                    <input type="checkbox" name="filter_after_rewrite" id="filter_after_rewrite"
                        class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="filter_after_rewrite" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                        Apply path filters after rewrites
                    </label>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">By default, filters apply to original paths before rewrites. Enable this to filter on rewritten paths instead.</p>
            </div>

            <!-- Exclude Extensions -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Extensions</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reject files with these extensions (e.g., .nfo, .txt, .jpg)</p>
                    </div>
                    <button type="button" onclick="addExcludeExtension()" class="btn-secondary text-xs">
                        Add
                    </button>
                </div>
                <div id="exclude-extensions-list" class="space-y-2">
                    <!-- Exclude extensions will be added here dynamically -->
                </div>
            </div>

            <!-- Advanced Filters (Regex) -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Advanced Filters (Regex)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use regular expressions for complex filtering. Applied after basic filters.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
                    <!-- Include Patterns -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Include Patterns (match any)</label>
                            <button type="button" onclick="addAdvancedIncludePattern()" class="btn-secondary text-xs">Add</button>
                        </div>
                        <div id="advanced-include-patterns-list" class="space-y-2">
                            <!-- Include patterns will be added here dynamically -->
                        </div>
                    </div>
                    <!-- Exclude Patterns -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Exclude Patterns (reject any match)</label>
                            <button type="button" onclick="addAdvancedExcludePattern()" class="btn-secondary text-xs">Add</button>
                        </div>
                        <div id="advanced-exclude-patterns-list" class="space-y-2">
                            <!-- Exclude patterns will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Examples: <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">.*\.(mkv|mp4)$</code> for video files, <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">(?i)sample</code> for case-insensitive "sample"</p>
            </div>
        </div>

        <!-- Filesystem Settings Section -->
        <div id="filesystem-settings" class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-4">File Stability Settings</h4>
            <p id="filesystem-settings-desc" class="text-xs text-gray-500 dark:text-gray-400 mb-4">Configure how to wait for files before processing. Remote filesystems use a simple delay; local filesystems check if file size has stopped changing.</p>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div id="filesystem-type-field">
                    <label for="filesystem_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filesystem Type</label>
                    <select name="filesystem_type" id="filesystem_type"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <option value="remote">Remote (network/cloud storage)</option>
                        <option value="local">Local (direct-attached storage)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Remote uses dumb delay; local checks file stability</p>
                </div>
                <div>
                    <label for="minimum_age_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum Age (seconds)</label>
                    <input type="text" inputmode="numeric" name="minimum_age_seconds" id="minimum_age_seconds" value="60"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p id="minimum-age-desc" class="mt-1 text-xs text-gray-500 dark:text-gray-400">Wait time before processing (min 60s for remote, 1s for local)</p>
                </div>
                <div id="stability-check-field">
                    <label for="stability_check_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Stability Check Interval (seconds)</label>
                    <input type="text" inputmode="numeric" name="stability_check_seconds" id="stability_check_seconds" value="10"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to check if file size has changed (local only)</p>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-3">
            <a href="/triggers" class="btn-secondary">Cancel</a>
            <button type="submit" class="btn-primary">Create Trigger</button>
        </div>
    </form>

    <script>
    (function() {
        const typeSelect = document.getElementById('type');
        const inotifyFields = document.getElementById('inotify-fields');
        const pollingFields = document.getElementById('polling-fields');
        const authFields = document.getElementById('auth-fields');
        const pathRewritesSection = document.getElementById('path-rewrites-section');
        const basicAuthFields = document.getElementById('basic-auth-fields');
        const authTypeApiKey = document.getElementById('auth_type_api_key');
        const authTypeBasic = document.getElementById('auth_type_basic');
        const fsTypeSelect = document.getElementById('filesystem_type');
        const fsTypeField = document.getElementById('filesystem-type-field');
        const fsSettingsDesc = document.getElementById('filesystem-settings-desc');
        const minAgeDesc = document.getElementById('minimum-age-desc');
        const stabilityCheckField = document.getElementById('stability-check-field');
        const minAgeInput = document.getElementById('minimum_age_seconds');
        const filterTimingToggle = document.getElementById('filter-timing-toggle');

        function setSectionEnabled(section, enabled) {
            if (!section) return;
            const inputs = section.querySelectorAll('input, select, textarea');
            inputs.forEach((input) => {
                input.disabled = !enabled;
            });
        }

        function updateFields() {
            const isInotify = typeSelect.value === 'inotify';
            const isPolling = typeSelect.value === 'polling';
            const isLocalTrigger = isInotify || isPolling;

            // Show/hide type-specific fields
            inotifyFields.classList.toggle('hidden', !isInotify);
            pollingFields.classList.toggle('hidden', !isPolling);
            setSectionEnabled(inotifyFields, isInotify);
            setSectionEnabled(pollingFields, isPolling);
            authFields.classList.toggle('hidden', isLocalTrigger);

            // Hide path rewrites for local triggers
            if (pathRewritesSection) {
                pathRewritesSection.classList.toggle('hidden', isLocalTrigger);
            }

            // Hide filter timing toggle for local triggers (they don't use path rewrites)
            if (filterTimingToggle) {
                filterTimingToggle.classList.toggle('hidden', isLocalTrigger);
            }

            if (isLocalTrigger) {
                // For local triggers, force local filesystem settings
                fsTypeField.classList.add('hidden');
                fsTypeSelect.value = 'local';
                fsSettingsDesc.textContent = 'Configure how to wait for files before processing. Checks if file size has stopped changing.';
                minAgeDesc.textContent = 'Wait time before processing (minimum 1 second)';
                stabilityCheckField.classList.remove('hidden');
                minAgeInput.min = '1';
            } else {
                // Show filesystem type selector for webhook triggers
                fsTypeField.classList.remove('hidden');
                fsSettingsDesc.textContent = 'Configure how to wait for files before processing. Remote filesystems use a simple delay; local filesystems check if file size has stopped changing.';
                minAgeDesc.textContent = 'Wait time before processing (min 60s for remote, 1s for local)';
                updateFilesystemFields();
            }
        }

        function updateAuthFields() {
            if (authTypeBasic.checked) {
                basicAuthFields.classList.remove('hidden');
            } else {
                basicAuthFields.classList.add('hidden');
            }
        }

        function updateFilesystemFields() {
            if (fsTypeSelect.value === 'local') {
                stabilityCheckField.classList.remove('hidden');
                minAgeInput.min = '1';
            } else {
                stabilityCheckField.classList.add('hidden');
                minAgeInput.min = '60';
                if (parseInt(minAgeInput.value) < 60) {
                    minAgeInput.value = '60';
                }
            }
        }

        typeSelect.addEventListener('change', updateFields);
        authTypeApiKey.addEventListener('change', updateAuthFields);
        authTypeBasic.addEventListener('change', updateAuthFields);
        fsTypeSelect.addEventListener('change', updateFilesystemFields);
        updateFields();
        updateAuthFields();
    })();

    function addWatchPath() {
        const list = document.getElementById('watch-paths-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 watch-path-row';
        row.innerHTML = `
            <input type="text" name="watch_paths[]" placeholder="/mnt/media/tv" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addPollingWatchPath() {
        const list = document.getElementById('polling-watch-paths-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 watch-path-row';
        row.innerHTML = `
            <input type="text" name="watch_paths[]" placeholder="/mnt/media/tv" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    // Validates that path rewrites don't mix simple and regex types
    function validatePathRewrites(listId) {
        const list = document.getElementById(listId);
        if (!list) return true;

        const hiddenInputs = list.querySelectorAll('input[name="path_rewrites_is_regex[]"]');
        const fromInputs = list.querySelectorAll('input[name="path_rewrites_from[]"]');

        let hasSimple = false;
        let hasRegex = false;

        hiddenInputs.forEach((input, index) => {
            // Only count rows that have non-empty from values
            const fromValue = fromInputs[index] ? fromInputs[index].value.trim() : '';
            if (fromValue === '') return;

            if (input.value === 'true') {
                hasRegex = true;
            } else {
                hasSimple = true;
            }
        });

        if (hasSimple && hasRegex) {
            showAlertModal('error', 'Invalid Configuration', 'Cannot mix simple and regex path rewrites. Please use only one type.');
            return false;
        }

        return true;
    }

    function addPathRewrite(isRegex) {
        const list = document.getElementById('path-rewrites-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 path-rewrite-row';
        const typeLabel = isRegex ? 'Regex' : 'Simple';
        const typeBadgeColor = isRegex ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
        const fromPlaceholder = isRegex ? 'From: ^/downloads/(.+)/(.+)$' : 'From: /data/media';
        const toPlaceholder = isRegex ? 'To: /media/$1/$2' : 'To: /mnt/media';
        row.innerHTML = `
            <input type="hidden" name="path_rewrites_is_regex[]" value="${isRegex}">
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${typeBadgeColor}">${typeLabel}</span>
            <input type="text" name="path_rewrites_from[]" placeholder="${fromPlaceholder}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <span class="text-gray-500 dark:text-gray-400">&rarr;</span>
            <input type="text" name="path_rewrites_to[]" placeholder="${toPlaceholder}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.path-rewrite-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addIncludePath() {
        const list = document.getElementById('include-paths-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 include-path-row';
        row.innerHTML = `
            <input type="text" name="include_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.include-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addExcludePath() {
        const list = document.getElementById('exclude-paths-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 exclude-path-row';
        row.innerHTML = `
            <input type="text" name="exclude_paths[]" placeholder="/mnt/media/movies/sample" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.exclude-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addExcludeExtension() {
        const list = document.getElementById('exclude-extensions-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 exclude-ext-row';
        row.innerHTML = `
            <input type="text" name="exclude_extensions[]" placeholder=".nfo" class="w-32 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            <button type="button" onclick="this.closest('.exclude-ext-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addAdvancedIncludePattern() {
        const list = document.getElementById('advanced-include-patterns-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 adv-include-row';
        row.innerHTML = `
            <input type="text" name="advanced_include_patterns[]" placeholder=".*\\.(mkv|mp4)$" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
            <button type="button" onclick="this.closest('.adv-include-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }

    function addAdvancedExcludePattern() {
        const list = document.getElementById('advanced-exclude-patterns-list');
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 adv-exclude-row';
        row.innerHTML = `
            <input type="text" name="advanced_exclude_patterns[]" placeholder="(?i)sample" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
            <button type="button" onclick="this.closest('.adv-exclude-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        `;
        list.appendChild(row);
    }
    </script>

    {{else if .Content.Trigger}}
    <!-- Edit Trigger Form -->
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Edit Trigger</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Update trigger settings.</p>
        </div>
    </div>

    <form action="/triggers/{{.Content.Trigger.ID}}" method="POST" class="bg-white dark:bg-gray-800 shadow rounded-lg p-6 space-y-6" onsubmit="return validateEditPathRewrites()">
        <input type="hidden" name="_method" value="PUT">

        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                <input type="text" name="name" id="name" required value="{{.Content.Trigger.Name}}"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label>
                <p class="mt-1 text-sm text-gray-900 dark:text-white py-2">{{.Content.Trigger.Type}}</p>
            </div>
            <div>
                <label for="priority" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Priority</label>
                <input type="text" inputmode="numeric" name="priority" id="priority" value="{{.Content.Trigger.Priority}}"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            </div>
            <div class="flex items-center pt-6">
                <input type="checkbox" name="enabled" id="enabled" {{if .Content.Trigger.Enabled}}checked{{end}}
                    class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                <label for="enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Enabled</label>
            </div>
        </div>

        {{if eq .Content.Trigger.Type "inotify"}}
        <!-- Inotify-specific fields -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Watch Paths</label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Directories to monitor for file changes</p>
                <div id="edit-watch-paths-list" class="space-y-2">
                    {{range .Content.Trigger.Config.WatchPaths}}
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" value="{{.}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{else}}
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{end}}
                </div>
                <button type="button" onclick="addEditWatchPath()" class="mt-2 inline-flex items-center text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Watch Path
                </button>
            </div>
            <div>
                <label for="debounce_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Debounce Delay (seconds)</label>
                <input type="text" inputmode="numeric" name="debounce_seconds" id="debounce_seconds" value="{{if .Content.Trigger.Config.DebounceSeconds}}{{.Content.Trigger.Config.DebounceSeconds}}{{else}}5{{end}}"
                    class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Wait time after file activity before triggering a scan (prevents duplicate scans)</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Actions</label>
                <div class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-3">
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_enabled" id="scan_enabled" {{if .Content.Trigger.Config.ScanEnabledValue}}checked{{end}}
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger scans</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="upload_enabled" id="upload_enabled" {{if .Content.Trigger.Config.UploadEnabledValue}}checked{{end}}
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="upload_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger uploads</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_existing_on_start" id="scan_existing_on_start" {{if .Content.Trigger.Config.ScanExistingOnStart}}checked{{end}}
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_existing_on_start" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Scan existing files on start</label>
                    </div>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Startup scans respect the scan/upload toggles above.</p>
            </div>
        </div>

        <script>
        function addEditWatchPath() {
            const list = document.getElementById('edit-watch-paths-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 watch-path-row';
            row.innerHTML = `
                <input type="text" name="watch_paths[]" placeholder="/mnt/media/tv" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }
        </script>
        {{else if eq .Content.Trigger.Type "polling"}}
        <!-- Polling-specific fields -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6 space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Watch Paths</label>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Directories to scan periodically for new files</p>
                <div id="edit-polling-watch-paths-list" class="space-y-2">
                    {{range .Content.Trigger.Config.WatchPaths}}
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" value="{{.}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{else}}
                    <div class="flex items-center gap-2 watch-path-row">
                        <input type="text" name="watch_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{end}}
                </div>
                <button type="button" onclick="addEditPollingWatchPath()" class="mt-2 inline-flex items-center text-sm text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add Watch Path
                </button>
            </div>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="poll_interval_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Poll Interval (seconds)</label>
                    <input type="text" inputmode="numeric" name="poll_interval_seconds" id="poll_interval_seconds" value="{{if .Content.Trigger.Config.PollIntervalSeconds}}{{.Content.Trigger.Config.PollIntervalSeconds}}{{else}}60{{end}}"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to scan directories for new files (minimum 10 seconds)</p>
                </div>
                <div class="flex items-center pt-6">
                    <input type="checkbox" name="queue_existing_on_start" id="queue_existing_on_start" {{if .Content.Trigger.Config.QueueExistingOnStart}}checked{{end}}
                        class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="queue_existing_on_start" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Queue existing files on start</label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Actions</label>
                <div class="mt-2 grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div class="flex items-center">
                        <input type="checkbox" name="scan_enabled" id="scan_enabled" {{if .Content.Trigger.Config.ScanEnabledValue}}checked{{end}}
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="scan_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger scans</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" name="upload_enabled" id="upload_enabled" {{if .Content.Trigger.Config.UploadEnabledValue}}checked{{end}}
                            class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                        <label for="upload_enabled" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">Trigger uploads</label>
                    </div>
                </div>
            </div>
        </div>

        <script>
        function addEditPollingWatchPath() {
            const list = document.getElementById('edit-polling-watch-paths-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 watch-path-row';
            row.innerHTML = `
                <input type="text" name="watch_paths[]" placeholder="/mnt/media/tv" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <button type="button" onclick="this.closest('.watch-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }
        </script>
        {{else}}
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Webhook URL</label>
            <div class="mt-2 flex items-center gap-2">
                <code class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded px-3 py-2 text-sm font-mono break-all">{{.Content.BaseURL}}/api/triggers/{{.Content.Trigger.Type}}/{{.Content.Trigger.ID}}</code>
                <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent.trim())"
                    class="btn-secondary text-xs">Copy</button>
            </div>

            {{if eq .Content.Trigger.AuthType "basic"}}
            <!-- Basic Auth credentials display -->
            <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
                <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-3">Basic Authentication</h4>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-blue-700 dark:text-blue-400 w-20">Username:</span>
                        <code class="flex-1 bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded text-sm font-mono text-blue-800 dark:text-blue-200">{{.Content.Trigger.Username}}</code>
                        <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)"
                            class="btn-secondary text-xs flex-shrink-0">Copy</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-blue-700 dark:text-blue-400 w-20">Password:</span>
                        <code class="flex-1 bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded text-sm font-mono text-blue-800 dark:text-blue-200">{{.Content.DecryptedPassword}}</code>
                        <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)"
                            class="btn-secondary text-xs flex-shrink-0">Copy</button>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" onclick="showUpdatePasswordModal()"
                        class="text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">
                        Change Password
                    </button>
                </div>
            </div>
            {{else}}
            <!-- API Key display -->
            <div class="mt-4 p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                <h4 class="text-sm font-medium text-green-800 dark:text-green-300 mb-2">API Key Authentication</h4>
                <div class="flex items-center gap-2 mt-2">
                    <code class="flex-1 bg-green-100 dark:bg-green-800 px-2 py-1 rounded text-sm font-mono text-green-800 dark:text-green-200 break-all">{{.Content.Trigger.APIKey}}</code>
                    <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)"
                        class="btn-secondary text-xs flex-shrink-0">Copy Key</button>
                </div>
                <p class="text-xs text-green-600 dark:text-green-400 mt-2">
                    Pass the API key via the <code class="bg-green-100 dark:bg-green-800 px-1 rounded">X-API-Key</code> header (recommended) or as a query parameter.
                </p>
                <div class="mt-3">
                    <button type="button" hx-post="/triggers/{{.Content.Trigger.ID}}/regenerate-key" hx-swap="none"
                        hx-confirm="Are you sure you want to regenerate the API key? The old key will stop working."
                        hx-on::after-request="if(event.detail.successful) window.location.reload()"
                        class="text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">
                        Regenerate API Key
                    </button>
                </div>
            </div>
            {{end}}
        </div>

        {{if eq .Content.Trigger.AuthType "basic"}}
        <!-- Password Update Modal -->
        <div id="password-modal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Change Trigger Password</h3>
                <form id="password-form" onsubmit="submitPasswordChange(event)">
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Password</label>
                        <input type="password" name="new_password" id="new_password" required
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                            placeholder="Enter new password">
                    </div>
                    <div class="mt-4 flex justify-end gap-3">
                        <button type="button" onclick="hideUpdatePasswordModal()" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Update Password</button>
                    </div>
                </form>
                <div id="password-result" class="mt-3 hidden"></div>
            </div>
        </div>
        <script>
        function showUpdatePasswordModal() {
            document.getElementById('password-modal').classList.remove('hidden');
        }
        function hideUpdatePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('new_password').value = '';
            document.getElementById('password-result').classList.add('hidden');
        }
        async function submitPasswordChange(e) {
            e.preventDefault();
            const form = document.getElementById('password-form');
            const resultDiv = document.getElementById('password-result');
            const formData = new FormData(form);

            try {
                const response = await fetch('/triggers/{{.Content.Trigger.ID}}/update-password', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                resultDiv.classList.remove('hidden');
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="rounded-md bg-green-50 dark:bg-green-900/30 p-3 text-sm text-green-700 dark:text-green-300">Password updated successfully!</div>';
                    setTimeout(hideUpdatePasswordModal, 1500);
                } else {
                    resultDiv.innerHTML = '<div class="rounded-md bg-red-50 dark:bg-red-900/30 p-3 text-sm text-red-700 dark:text-red-300">' + (data.error || 'Failed to update password') + '</div>';
                }
            } catch (err) {
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="rounded-md bg-red-50 dark:bg-red-900/30 p-3 text-sm text-red-700 dark:text-red-300">Network error: ' + err.message + '</div>';
            }
        }
        </script>
        {{end}}
        {{end}}

        <!-- Path Rewrites Section (for webhook trigger types only, not local triggers) -->
        {{if and (ne .Content.Trigger.Type "inotify") (ne .Content.Trigger.Type "polling")}}
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <div>
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Path Rewrites (Optional)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Translate incoming paths. Use simple prefix replacement or regex with capture groups ($1, $2, etc.)</p>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="addEditPathRewrite(false)" class="btn-secondary text-xs">
                            Add Simple
                        </button>
                        <button type="button" onclick="addEditPathRewrite(true)" class="btn-secondary text-xs">
                            Add Regex
                        </button>
                    </div>
                </div>
                <div id="edit-path-rewrites-list" class="space-y-2">
                    {{range .Content.Trigger.Config.PathRewrites}}
                    <div class="flex items-center gap-2 path-rewrite-row">
                        <input type="hidden" name="path_rewrites_is_regex[]" value="{{.IsRegex}}">
                        {{if .IsRegex}}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200">Regex</span>
                        {{else}}
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Simple</span>
                        {{end}}
                        <input type="text" name="path_rewrites_from[]" value="{{.From}}" placeholder="{{if .IsRegex}}From: ^/downloads/(.+)/(.+)${{else}}From: /data/media{{end}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <span class="text-gray-500 dark:text-gray-400">&rarr;</span>
                        <input type="text" name="path_rewrites_to[]" value="{{.To}}" placeholder="{{if .IsRegex}}To: /media/$1/$2{{else}}To: /mnt/media{{end}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="button" onclick="this.closest('.path-rewrite-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}

        <script>
        // Validates that path rewrites don't mix simple and regex types
        function validateEditPathRewrites() {
            const list = document.getElementById('edit-path-rewrites-list');
            if (!list) return true;

            const hiddenInputs = list.querySelectorAll('input[name="path_rewrites_is_regex[]"]');
            const fromInputs = list.querySelectorAll('input[name="path_rewrites_from[]"]');

            let hasSimple = false;
            let hasRegex = false;

            hiddenInputs.forEach((input, index) => {
                // Only count rows that have non-empty from values
                const fromValue = fromInputs[index] ? fromInputs[index].value.trim() : '';
                if (fromValue === '') return;

                if (input.value === 'true') {
                    hasRegex = true;
                } else {
                    hasSimple = true;
                }
            });

            if (hasSimple && hasRegex) {
                showAlertModal('error', 'Invalid Configuration', 'Cannot mix simple and regex path rewrites. Please use only one type.');
                return false;
            }

            return true;
        }

        function addEditPathRewrite(isRegex) {
            const list = document.getElementById('edit-path-rewrites-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 path-rewrite-row';
            const typeLabel = isRegex ? 'Regex' : 'Simple';
            const typeBadgeColor = isRegex ? 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
            const fromPlaceholder = isRegex ? 'From: ^/downloads/(.+)/(.+)$' : 'From: /data/media';
            const toPlaceholder = isRegex ? 'To: /media/$1/$2' : 'To: /mnt/media';
            row.innerHTML = `
                <input type="hidden" name="path_rewrites_is_regex[]" value="${isRegex}">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${typeBadgeColor}">${typeLabel}</span>
                <input type="text" name="path_rewrites_from[]" placeholder="${fromPlaceholder}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <span class="text-gray-500 dark:text-gray-400">&rarr;</span>
                <input type="text" name="path_rewrites_to[]" placeholder="${toPlaceholder}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <button type="button" onclick="this.closest('.path-rewrite-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }

        function addEditIncludePath() {
            const list = document.getElementById('edit-include-paths-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 include-path-row';
            row.innerHTML = `
                <input type="text" name="include_paths[]" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <button type="button" onclick="this.closest('.include-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }

        function addEditExcludePath() {
            const list = document.getElementById('edit-exclude-paths-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 exclude-path-row';
            row.innerHTML = `
                <input type="text" name="exclude_paths[]" placeholder="/mnt/media/movies/sample" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <button type="button" onclick="this.closest('.exclude-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }

        function addEditExcludeExtension() {
            const list = document.getElementById('edit-exclude-extensions-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-1 exclude-ext-row';
            row.innerHTML = `
                <input type="text" name="exclude_extensions[]" placeholder=".nfo" class="w-24 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1 border">
                <button type="button" onclick="this.closest('.exclude-ext-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }

        function addEditAdvancedIncludePattern() {
            const list = document.getElementById('edit-advanced-include-patterns-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 adv-include-row';
            row.innerHTML = `
                <input type="text" name="advanced_include_patterns[]" placeholder=".*\\.(mkv|mp4)$" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
                <button type="button" onclick="this.closest('.adv-include-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }

        function addEditAdvancedExcludePattern() {
            const list = document.getElementById('edit-advanced-exclude-patterns-list');
            const row = document.createElement('div');
            row.className = 'flex items-center gap-2 adv-exclude-row';
            row.innerHTML = `
                <input type="text" name="advanced_exclude_patterns[]" placeholder="(?i)sample" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
                <button type="button" onclick="this.closest('.adv-exclude-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            `;
            list.appendChild(row);
        }
        </script>

        <!-- Path Filters Section (Edit form) -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Path Filters (Optional)</h4>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Filter which paths this trigger will accept. Include paths are checked first (if any specified, path must match at least one). Exclude paths are then checked (path matching any will be rejected).</p>

            <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                <!-- Include Paths -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Include Paths</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Only accept paths starting with these prefixes (leave empty to accept all)</p>
                        </div>
                        <button type="button" onclick="addEditIncludePath()" class="btn-secondary text-xs">
                            Add
                        </button>
                    </div>
                    <div id="edit-include-paths-list" class="space-y-2">
                        {{range .Content.Trigger.Config.IncludePaths}}
                        <div class="flex items-center gap-2 include-path-row">
                            <input type="text" name="include_paths[]" value="{{.}}" placeholder="/mnt/media/movies" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                            <button type="button" onclick="this.closest('.include-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        {{end}}
                    </div>
                </div>

                <!-- Exclude Paths -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Paths</label>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reject paths starting with these prefixes</p>
                        </div>
                        <button type="button" onclick="addEditExcludePath()" class="btn-secondary text-xs">
                            Add
                        </button>
                    </div>
                    <div id="edit-exclude-paths-list" class="space-y-2">
                        {{range .Content.Trigger.Config.ExcludePaths}}
                        <div class="flex items-center gap-2 exclude-path-row">
                            <input type="text" name="exclude_paths[]" value="{{.}}" placeholder="/mnt/media/movies/sample" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                            <button type="button" onclick="this.closest('.exclude-path-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Filter Timing Toggle (for webhook triggers only) -->
            {{if and (ne .Content.Trigger.Type "inotify") (ne .Content.Trigger.Type "polling")}}
            <div class="mt-4">
                <div class="flex items-center">
                    <input type="checkbox" name="filter_after_rewrite" id="edit_filter_after_rewrite"
                        {{if .Content.Trigger.Config.FilterAfterRewrite}}checked{{end}}
                        class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-indigo-600 focus:ring-indigo-500">
                    <label for="edit_filter_after_rewrite" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
                        Apply path filters after rewrites
                    </label>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">By default, filters apply to original paths before rewrites. Enable this to filter on rewritten paths instead.</p>
            </div>
            {{end}}

            <!-- Exclude Extensions -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Extensions</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Reject files with these extensions (e.g., .nfo, .txt, .jpg)</p>
                    </div>
                    <button type="button" onclick="addEditExcludeExtension()" class="btn-secondary text-xs">
                        Add
                    </button>
                </div>
                <div id="edit-exclude-extensions-list" class="space-y-2 flex flex-wrap gap-2">
                    {{range .Content.Trigger.Config.ExcludeExtensions}}
                    <div class="flex items-center gap-1 exclude-ext-row">
                        <input type="text" name="exclude_extensions[]" value="{{.}}" class="w-24 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1 border">
                        <button type="button" onclick="this.closest('.exclude-ext-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Advanced Filters (Regex) -->
            <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Advanced Filters (Regex)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use regular expressions for complex filtering. Applied after basic filters.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
                    <!-- Include Patterns -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Include Patterns (match any)</label>
                            <button type="button" onclick="addEditAdvancedIncludePattern()" class="btn-secondary text-xs">Add</button>
                        </div>
                        <div id="edit-advanced-include-patterns-list" class="space-y-2">
                            {{if .Content.Trigger.Config.AdvancedFilters}}
                            {{range .Content.Trigger.Config.AdvancedFilters.IncludePatterns}}
                            <div class="flex items-center gap-2 adv-include-row">
                                <input type="text" name="advanced_include_patterns[]" value="{{.}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
                                <button type="button" onclick="this.closest('.adv-include-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            {{end}}
                            {{end}}
                        </div>
                    </div>
                    <!-- Exclude Patterns -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-400">Exclude Patterns (reject any match)</label>
                            <button type="button" onclick="addEditAdvancedExcludePattern()" class="btn-secondary text-xs">Add</button>
                        </div>
                        <div id="edit-advanced-exclude-patterns-list" class="space-y-2">
                            {{if .Content.Trigger.Config.AdvancedFilters}}
                            {{range .Content.Trigger.Config.AdvancedFilters.ExcludePatterns}}
                            <div class="flex items-center gap-2 adv-exclude-row">
                                <input type="text" name="advanced_exclude_patterns[]" value="{{.}}" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border font-mono text-xs">
                                <button type="button" onclick="this.closest('.adv-exclude-row').remove()" class="text-red-600 dark:text-red-400 hover:text-red-500 p-1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            {{end}}
                            {{end}}
                        </div>
                    </div>
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Examples: <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">.*\.(mkv|mp4)$</code> for video files, <code class="bg-gray-100 dark:bg-gray-700 px-1 rounded">(?i)sample</code> for case-insensitive "sample"</p>
            </div>
        </div>

        <!-- Filesystem Settings Section (Edit form) -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-4">File Stability Settings</h4>
            {{if eq .Content.Trigger.Type "inotify"}}
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Configure how to wait for files before processing. Checks if file size has stopped changing.</p>

            <input type="hidden" name="filesystem_type" value="local">
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                    <label for="edit_minimum_age_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum Age (seconds)</label>
                    <input type="text" inputmode="numeric" name="minimum_age_seconds" id="edit_minimum_age_seconds" value="{{if .Content.Trigger.Config.MinimumAgeSeconds}}{{.Content.Trigger.Config.MinimumAgeSeconds}}{{else}}10{{end}}"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border"
                        min="1">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Wait time before processing (minimum 1 second)</p>
                </div>
                <div>
                    <label for="edit_stability_check_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Stability Check Interval (seconds)</label>
                    <input type="text" inputmode="numeric" name="stability_check_seconds" id="edit_stability_check_seconds" value="{{if .Content.Trigger.Config.StabilityCheckSeconds}}{{.Content.Trigger.Config.StabilityCheckSeconds}}{{else}}10{{end}}"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to check if file size has changed</p>
                </div>
            </div>
            {{else}}
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Configure how to wait for files before processing. Remote filesystems use a simple delay; local filesystems check if file size has stopped changing.</p>

            <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                <div>
                    <label for="edit_filesystem_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Filesystem Type</label>
                    <select name="filesystem_type" id="edit_filesystem_type"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <option value="remote" {{if eq .Content.Trigger.Config.FilesystemType "remote"}}selected{{end}} {{if not .Content.Trigger.Config.FilesystemType}}selected{{end}}>Remote (network/cloud storage)</option>
                        <option value="local" {{if eq .Content.Trigger.Config.FilesystemType "local"}}selected{{end}}>Local (direct-attached storage)</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Remote uses dumb delay; local checks file stability</p>
                </div>
                <div>
                    <label for="edit_minimum_age_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum Age (seconds)</label>
                    <input type="text" inputmode="numeric" name="minimum_age_seconds" id="edit_minimum_age_seconds" value="{{if .Content.Trigger.Config.MinimumAgeSeconds}}{{.Content.Trigger.Config.MinimumAgeSeconds}}{{else}}60{{end}}"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Wait time before processing (min 60s for remote, 1s for local)</p>
                </div>
                <div id="edit-stability-check-field">
                    <label for="edit_stability_check_seconds" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Stability Check Interval (seconds)</label>
                    <input type="text" inputmode="numeric" name="stability_check_seconds" id="edit_stability_check_seconds" value="{{if .Content.Trigger.Config.StabilityCheckSeconds}}{{.Content.Trigger.Config.StabilityCheckSeconds}}{{else}}10{{end}}"
                        class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">How often to check if file size has changed (local only)</p>
                </div>
            </div>

            <script>
            (function() {
                const fsTypeSelect = document.getElementById('edit_filesystem_type');
                const stabilityCheckField = document.getElementById('edit-stability-check-field');
                const minAgeInput = document.getElementById('edit_minimum_age_seconds');

                function updateEditFilesystemFields() {
                    if (fsTypeSelect.value === 'local') {
                        stabilityCheckField.classList.remove('hidden');
                        minAgeInput.min = '1';
                    } else {
                        stabilityCheckField.classList.add('hidden');
                        minAgeInput.min = '60';
                        if (parseInt(minAgeInput.value) < 60) {
                            minAgeInput.value = '60';
                        }
                    }
                }

                fsTypeSelect.addEventListener('change', updateEditFilesystemFields);
                updateEditFilesystemFields();
            })();
            </script>
            {{end}}
        </div>

        <div class="flex justify-end gap-3">
            <a href="/triggers" class="btn-secondary">Cancel</a>
            <button type="submit" class="btn-primary">Save Changes</button>
        </div>
    </form>

    {{else}}
    <!-- Triggers List -->
    <div class="sm:flex sm:items-center sm:justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Triggers</h1>
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Configure webhook triggers for Sonarr, Radarr, Lidarr, and generic webhooks.</p>
        </div>
        <div class="mt-4 sm:mt-0">
            <a href="/triggers/new" class="btn-primary inline-flex items-center gap-2">
                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Trigger
            </a>
        </div>
    </div>

    <!-- Quick Manual Scan -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
                <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-indigo-600">
                    <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <h3 class="text-base font-semibold text-gray-900 dark:text-white">Quick Manual Scan</h3>
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manually queue a path for scanning without using a webhook trigger.</p>
                <form id="manual-scan-form" class="mt-4">
                    <div class="flex gap-3">
                        <input type="text" name="path" id="manual-scan-path" required
                            placeholder="/mnt/media/movies/Movie Name (2024)"
                            class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        <button type="submit" id="manual-scan-btn" class="btn-primary inline-flex items-center gap-2">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            Queue Scan
                        </button>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Enter an absolute path to a file or directory. The scan will be processed immediately without waiting for minimum age.</p>
                </form>
                <div id="manual-scan-result" class="mt-3 hidden">
                    <div id="manual-scan-success" class="hidden rounded-md bg-green-50 dark:bg-green-900/30 p-3">
                        <div class="flex">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
                            </svg>
                            <p class="ml-3 text-sm text-green-700 dark:text-green-300" id="manual-scan-success-msg"></p>
                        </div>
                    </div>
                    <div id="manual-scan-error" class="hidden rounded-md bg-red-50 dark:bg-red-900/30 p-3">
                        <div class="flex">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd"/>
                            </svg>
                            <p class="ml-3 text-sm text-red-700 dark:text-red-300" id="manual-scan-error-msg"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    (function() {
        const form = document.getElementById('manual-scan-form');
        const pathInput = document.getElementById('manual-scan-path');
        const submitBtn = document.getElementById('manual-scan-btn');
        const resultDiv = document.getElementById('manual-scan-result');
        const successDiv = document.getElementById('manual-scan-success');
        const errorDiv = document.getElementById('manual-scan-error');
        const successMsg = document.getElementById('manual-scan-success-msg');
        const errorMsg = document.getElementById('manual-scan-error-msg');

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const path = pathInput.value.trim();
            if (!path) return;

            // Disable button and show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Queueing...';

            try {
                const response = await fetch('/triggers/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path: path })
                });

                const data = await response.json();

                resultDiv.classList.remove('hidden');

                if (response.ok) {
                    successDiv.classList.remove('hidden');
                    errorDiv.classList.add('hidden');
                    successMsg.textContent = data.message || 'Scan queued successfully for: ' + path;
                    pathInput.value = '';
                } else {
                    successDiv.classList.add('hidden');
                    errorDiv.classList.remove('hidden');
                    errorMsg.textContent = data.error || 'Failed to queue scan';
                }
            } catch (err) {
                resultDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                errorMsg.textContent = 'Network error: ' + err.message;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Queue Scan';
            }
        });
    })();
    </script>

    <!-- Trigger Details Modal -->
    <div id="trigger-details-modal" class="hidden fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-3xl w-full mx-4 shadow-2xl border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="trigger-details-title">Trigger Details</h3>
                <button type="button" onclick="hideTriggerDetails()" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- Webhook URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Webhook URL</label>
                    <div class="flex items-center gap-2">
                        <code id="trigger-details-url" class="flex-1 bg-gray-100 dark:bg-gray-700 dark:text-gray-200 rounded px-3 py-2 text-sm font-mono break-all"></code>
                        <button type="button" onclick="copyToClipboard(document.getElementById('trigger-details-url').textContent.trim())"
                            class="btn-secondary text-xs flex-shrink-0">Copy</button>
                    </div>
                </div>

                <!-- Authentication Info -->
                <div id="trigger-details-auth" class="p-4 rounded-lg">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button type="button" onclick="hideTriggerDetails()" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <script>
    function showTriggerDetails(id, name, type, authType, apiKey, username, password, baseURL) {
        const modal = document.getElementById('trigger-details-modal');
        const title = document.getElementById('trigger-details-title');
        const urlEl = document.getElementById('trigger-details-url');
        const authEl = document.getElementById('trigger-details-auth');

        title.textContent = name;

        const webhookURL = baseURL + '/api/triggers/' + type + '/' + id;
        urlEl.textContent = webhookURL;

        if (authType === 'basic') {
            authEl.className = 'p-4 rounded-lg bg-blue-50 dark:bg-blue-900/30';
            authEl.innerHTML = `
                <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-3">Basic Authentication</h4>
                <div class="space-y-2">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-blue-700 dark:text-blue-400 w-20">Username:</span>
                        <code class="flex-1 bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded text-sm font-mono text-blue-800 dark:text-blue-200">${escapeHtml(username)}</code>
                        <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)" class="btn-secondary text-xs flex-shrink-0">Copy</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-blue-700 dark:text-blue-400 w-20">Password:</span>
                        <code class="flex-1 bg-blue-100 dark:bg-blue-800 px-2 py-1 rounded text-sm font-mono text-blue-800 dark:text-blue-200">${escapeHtml(password)}</code>
                        <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)" class="btn-secondary text-xs flex-shrink-0">Copy</button>
                    </div>
                </div>
            `;
        } else {
            authEl.className = 'p-4 rounded-lg bg-green-50 dark:bg-green-900/30';
            authEl.innerHTML = `
                <h4 class="text-sm font-medium text-green-800 dark:text-green-300 mb-2">API Key Authentication</h4>
                <div class="flex items-center gap-2 mt-2">
                    <code class="flex-1 bg-green-100 dark:bg-green-800 px-2 py-1 rounded text-sm font-mono text-green-800 dark:text-green-200 break-all">${escapeHtml(apiKey)}</code>
                    <button type="button" onclick="copyToClipboard(this.previousElementSibling.textContent)" class="btn-secondary text-xs flex-shrink-0">Copy Key</button>
                </div>
                <p class="text-xs text-green-600 dark:text-green-400 mt-2">
                    Pass the API key via the <code class="bg-green-100 dark:bg-green-800 px-1 rounded">X-API-Key</code> header (recommended) or as a query parameter.
                </p>
                <div class="mt-3 space-y-2">
                    <button type="button"
                        onclick="showRegenKeyConfirm(${id})"
                        class="text-sm text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">
                        Regenerate API Key
                    </button>
                    <div id="regen-key-confirm" class="hidden mt-2 p-3 rounded-md bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800">
                        <p class="text-sm text-yellow-800 dark:text-yellow-200 mb-2">Regenerate the API key? The old key will stop working immediately.</p>
                        <div class="flex gap-2">
                            <button type="button" onclick="confirmRegenKey()" class="btn-primary text-xs">Regenerate</button>
                            <button type="button" onclick="hideRegenKeyConfirm()" class="btn-secondary text-xs">Cancel</button>
                        </div>
                        <div id="regen-key-status" class="hidden mt-2 text-sm"></div>
                    </div>
                </div>
            `;
        }

        modal.classList.remove('hidden');
    }

    function hideTriggerDetails() {
        document.getElementById('trigger-details-modal').classList.add('hidden');
    }

    let currentTriggerId = null;

    function showRegenKeyConfirm(id) {
        currentTriggerId = id;
        const confirmBox = document.getElementById('regen-key-confirm');
        const status = document.getElementById('regen-key-status');
        if (confirmBox) {
            confirmBox.classList.remove('hidden');
        }
        if (status) {
            status.classList.add('hidden');
            status.textContent = '';
            status.className = 'hidden mt-2 text-sm';
        }
    }

    function hideRegenKeyConfirm() {
        const confirmBox = document.getElementById('regen-key-confirm');
        if (confirmBox) {
            confirmBox.classList.add('hidden');
        }
    }

    async function confirmRegenKey() {
        const status = document.getElementById('regen-key-status');
        if (!currentTriggerId) {
            return;
        }
        try {
            const resp = await fetch('/triggers/' + currentTriggerId + '/regenerate-key', { method: 'POST' });
            if (resp.ok) {
                window.location.reload();
                return;
            }
            if (status) {
                status.classList.remove('hidden');
                status.classList.remove('text-green-600', 'dark:text-green-400');
                status.classList.add('text-red-600', 'dark:text-red-400');
                status.textContent = 'Failed to regenerate API key';
            }
        } catch (e) {
            if (status) {
                status.classList.remove('hidden');
                status.classList.remove('text-green-600', 'dark:text-green-400');
                status.classList.add('text-red-600', 'dark:text-red-400');
                status.textContent = 'Failed to regenerate API key';
            }
        }
    }

    function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(true, 'Copied to clipboard');
            });
        } else {
            // Fallback for non-secure contexts (HTTP)
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast(true, 'Copied to clipboard');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            hideTriggerDetails();
        }
    });

    // Close modal on backdrop click
    document.getElementById('trigger-details-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideTriggerDetails();
        }
    });
    </script>

    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Priority</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {{if .Content.Triggers}}
                    {{range .Content.Triggers}}
                    <tr id="trigger-{{.ID}}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">{{.Name}}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                {{if eq .Type "sonarr"}}bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-400
                                {{else if eq .Type "radarr"}}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-400
                                {{else if eq .Type "lidarr"}}bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-400
                                {{else if eq .Type "webhook"}}bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-400
                                {{else if eq .Type "autoplow"}}bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-400
                                {{else if eq .Type "a_train"}}bg-cyan-100 text-cyan-800 dark:bg-cyan-900/50 dark:text-cyan-400
                                {{else if eq .Type "autoscan"}}bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-400
                                {{else if eq .Type "inotify"}}bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-400
                                {{else if eq .Type "polling"}}bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-400
                                {{else}}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{{end}}">
                                {{.Type}}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{.Priority}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {{if .Enabled}}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-400">
                                Enabled
                            </span>
                            {{else}}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                                Disabled
                            </span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end gap-2">
                                {{if and (ne .Type "inotify") (ne .Type "polling")}}
                                <button type="button"
                                    onclick="showTriggerDetails({{.ID}}, '{{.Name}}', '{{.Type}}', '{{.AuthType}}', '{{.APIKey}}', '{{.Username}}', '{{index $.Content.Passwords .ID}}', '{{$.Content.BaseURL}}')"
                                    class="btn-primary text-sm">View</button>
                                {{end}}
                                <a href="/triggers/{{.ID}}" class="btn-primary text-sm">Edit</a>
                                <button type="button"
                                    hx-delete="/triggers/{{.ID}}"
                                    hx-target="#trigger-{{.ID}}"
                                    hx-swap="outerHTML"
                                    hx-confirm="Are you sure you want to delete this trigger?"
                                    class="btn-danger text-sm">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                    {{else}}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-center">
                            No triggers configured yet. <a href="/triggers/new" class="text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300">Add your first trigger</a>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800 dark:text-blue-300">Webhook Setup Instructions</h3>
                <div class="mt-2 text-sm text-blue-700 dark:text-blue-400">
                    <p>After creating a trigger, you'll receive a unique webhook URL. Configure this URL in your *arr application:</p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong>Sonarr/Radarr/Lidarr:</strong> Settings  Connect  Add  Webhook</li>
                        <li>Use the provided URL with the API key</li>
                        <li>Select relevant events (On Import, On Upgrade, etc.)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {{end}}
</div>
{{end}}

{{template "base" .}}
