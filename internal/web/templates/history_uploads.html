{{define "upload_history_stats"}}
<div id="upload-history-stats" class="grid grid-cols-2 gap-4 lg:grid-cols-5" hx-get="/history/uploads/stats{{if .Remote}}?remote={{.Remote}}{{end}}" hx-trigger="load, sse-refresh" hx-swap="innerHTML" hx-select="#upload-history-stats > *" data-sse-polling-fallback="10s">
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active</dt>
        <dd class="mt-1 text-2xl font-semibold text-blue-600 dark:text-blue-400">{{.ActiveCount}}</dd>
    </div>
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Pending</dt>
        <dd class="mt-1 text-2xl font-semibold text-yellow-600 dark:text-yellow-400">{{.PendingCount}}</dd>
    </div>
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Queued</dt>
        <dd class="mt-1 text-2xl font-semibold text-yellow-600 dark:text-yellow-400">{{.QueuedCount}}</dd>
    </div>
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Uploads</dt>
        <dd class="mt-1 text-2xl font-semibold text-green-600 dark:text-green-400">{{.TotalUploads}}</dd>
    </div>
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg p-4">
        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Uploaded</dt>
        <dd class="mt-1 text-2xl font-semibold text-gray-900 dark:text-white">{{formatBytes .TotalBytes}}</dd>
    </div>
</div>
{{end}}

{{define "upload_history_table"}}
<div id="upload-history-table" hx-get="/history/uploads/table?page={{.Page}}{{if .Remote}}&remote={{.Remote}}{{end}}" hx-trigger="load, sse-refresh" hx-swap="innerHTML" hx-select="#upload-history-table > *" data-sse-polling-fallback="5s">
    <!-- Uploads Table -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Local Path</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Remote</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Completed</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {{if .Uploads}}
                {{range .Uploads}}
                <tr>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-100">
                        <div class="break-all" title="{{.LocalPath}}">{{.LocalPath}}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{.RemoteName}}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{formatBytes .SizeBytes}}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400"><span class="pal-time" data-utc="{{isoTime .CompletedAt}}">{{formatTime .CompletedAt}}</span></td>
                </tr>
                {{end}}
                {{else}}
                <tr>
                    <td colspan="4" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-center">No upload history found</td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{if gt .TotalPages 1}}
        <div class="border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-3 sm:px-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="text-sm text-gray-700 dark:text-gray-300">
                <span class="font-medium">{{.TotalCount}}</span> uploads
            </div>
            <div class="flex items-center gap-2">
                {{if gt .TotalPages 1}}
                <a href="/history/uploads?page=1{{if .Remote}}&remote={{.Remote}}{{end}}"
                   class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 dark:ring-gray-600
                   {{if eq .Page 1}}text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 cursor-not-allowed{{else}}bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600{{end}}">
                    « First
                </a>
                <a href="/history/uploads?page={{.PrevPage}}{{if .Remote}}&remote={{.Remote}}{{end}}"
                   class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 dark:ring-gray-600
                   {{if .HasPrev}}bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600{{else}}text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 cursor-not-allowed{{end}}">
                    ‹ Prev
                </a>
                <span class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300">Page {{.Page}} / {{.TotalPages}}</span>
                <a href="/history/uploads?page={{.NextPage}}{{if .Remote}}&remote={{.Remote}}{{end}}"
                   class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 dark:ring-gray-600
                   {{if .HasNext}}bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600{{else}}text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 cursor-not-allowed{{end}}">
                    Next ›
                </a>
                <a href="/history/uploads?page={{.TotalPages}}{{if .Remote}}&remote={{.Remote}}{{end}}"
                   class="inline-flex items-center rounded-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-300 dark:ring-gray-600
                   {{if eq .Page .TotalPages}}text-gray-400 dark:text-gray-500 bg-gray-50 dark:bg-gray-800 cursor-not-allowed{{else}}bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600{{end}}">
                    Last »
                </a>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}

{{define "content"}}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Upload History</h1>
        <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">View completed uploads and transfer statistics.</p>
    </div>

    <!-- Stats cards -->
    {{template "upload_history_stats" .Content}}

    <!-- Remote Filter -->
    <div class="flex flex-wrap items-center gap-3">
        <div id="remote-filter" class="relative">
            {{ $remote := .Content.Remote }}
            <button type="button" class="relative inline-flex items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-3 py-1.5 shadow-sm text-sm font-medium text-gray-900 dark:text-gray-100 w-full"
                style="min-width: 12rem;">
                <svg class="w-4 h-4 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18" />
                </svg>
                <span class="whitespace-nowrap truncate block flex-1 text-left">{{if eq $remote ""}}All remotes{{else}}{{$remote}}{{end}}</span>
                <svg class="w-4 h-4 text-gray-400 dark:text-gray-500 absolute right-2 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div data-remote-menu class="hidden absolute z-20 mt-1 min-w-full max-w-xs rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-lg"
                style="min-width: 12rem;">
                <a href="/history/uploads" class="block px-3 py-2 text-sm text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 {{if eq $remote ""}}bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-200 font-semibold{{end}}">
                    <span class="truncate block">All remotes</span>
                </a>
                {{range .Content.Remotes}}
                {{ $name := . }}
                <a href="/history/uploads?remote={{$name}}" class="block px-3 py-2 text-sm text-gray-900 dark:text-gray-100 hover:bg-gray-50 dark:hover:bg-gray-700 {{if eq $remote $name}}bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-200 font-semibold{{end}}">
                    <span class="truncate block" title="{{$name}}">{{$name}}</span>
                </a>
                {{end}}
            </div>
        </div>
    </div>

    <script>
    (function() {
        const filter = document.getElementById('remote-filter');
        if (!filter) return;
        const button = filter.querySelector('button');
        const menu = filter.querySelector('[data-remote-menu]');

        function closeMenu() {
            menu.classList.add('hidden');
        }

        button.addEventListener('click', function(e) {
            e.preventDefault();
            menu.classList.toggle('hidden');
        });

        document.addEventListener('click', function(e) {
            if (!filter.contains(e.target)) {
                closeMenu();
            }
        });
    })();
    </script>

    {{template "upload_history_table" .Content}}
</div>
{{end}}

{{template "base" .}}
