{{define "base"}}
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Autoplow</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="/static/js/htmx.min.js"></script>
    <script src="/static/js/alpine.min.js" defer></script>
    <script src="/static/js/sse.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Theme detection and management
        (function() {
            function getTheme() {
                const stored = localStorage.getItem('theme');
                if (stored === 'dark' || stored === 'light') return stored;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            function applyTheme(theme) {
                document.documentElement.classList.toggle('dark', theme === 'dark');
            }
            applyTheme(getTheme());
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        })();

        // Profile modal Alpine.js component
        function profileModal(currentUsername) {
            return {
                activeTab: 'username',
                newUsername: currentUsername,
                currentPassword: '',
                newPassword: '',
                confirmPassword: '',
                usernameError: '',
                usernameSuccess: '',
                usernameLoading: false,
                passwordError: '',
                passwordSuccess: '',
                passwordLoading: false,

                async updateUsername() {
                    this.usernameError = '';
                    this.usernameSuccess = '';
                    this.usernameLoading = true;

                    try {
                        const formData = new FormData();
                        formData.append('username', this.newUsername);

                        const response = await fetch('/profile/username', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            this.usernameSuccess = data.message;
                            // Update the username display in the header
                            document.querySelectorAll('[x-ref="usernameDisplay"]').forEach(el => {
                                el.textContent = data.username;
                            });
                        } else {
                            this.usernameError = data.error || 'Failed to update username';
                        }
                    } catch (error) {
                        this.usernameError = 'An error occurred. Please try again.';
                    } finally {
                        this.usernameLoading = false;
                    }
                },

                async updatePassword() {
                    this.passwordError = '';
                    this.passwordSuccess = '';
                    this.passwordLoading = true;

                    if (this.newPassword !== this.confirmPassword) {
                        this.passwordError = 'New passwords do not match';
                        this.passwordLoading = false;
                        return;
                    }

                    try {
                        const formData = new FormData();
                        formData.append('current_password', this.currentPassword);
                        formData.append('new_password', this.newPassword);
                        formData.append('confirm_password', this.confirmPassword);

                        const response = await fetch('/profile/password', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            this.passwordSuccess = data.message;
                            this.currentPassword = '';
                            this.newPassword = '';
                            this.confirmPassword = '';
                        } else {
                            this.passwordError = data.error || 'Failed to update password';
                        }
                    } catch (error) {
                        this.passwordError = 'An error occurred. Please try again.';
                    } finally {
                        this.passwordLoading = false;
                    }
                }
            };
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="h-full bg-gray-100 dark:bg-gray-900 transition-colors" x-data="{ sidebarOpen: false, theme: localStorage.getItem('theme') || 'auto' }" x-init="$watch('theme', val => { if (val === 'auto') { localStorage.removeItem('theme'); document.documentElement.classList.toggle('dark', window.matchMedia('(prefers-color-scheme: dark)').matches); } else { localStorage.setItem('theme', val); document.documentElement.classList.toggle('dark', val === 'dark'); } })">
    {{if .User}}
    <div class="min-h-full flex flex-col">
        <!-- Top bar - full width -->
        <header class="sticky top-0 z-50 flex h-16 shrink-0 items-center gap-x-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 shadow-sm sm:gap-x-6 sm:px-6 lg:px-8 transition-colors">
            <!-- Mobile menu button -->
            <button type="button" class="-m-2.5 p-2.5 text-gray-700 dark:text-gray-300 lg:hidden" @click="sidebarOpen = true">
                <span class="sr-only">Open sidebar</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>

            <!-- Logo/Title -->
            <div class="flex items-center gap-x-3">
                <span class="text-xl font-bold text-gray-900 dark:text-white">Autoplow</span>
            </div>

            <!-- Spacer -->
            <div class="flex-1"></div>

            <!-- Right side items -->
            <div class="flex items-center gap-x-2">
                <!-- Theme Toggle -->
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" type="button" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="sr-only">Toggle theme</span>
                        <!-- Sun icon (light mode) -->
                        <svg x-show="theme === 'light'" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <!-- Moon icon (dark mode) -->
                        <svg x-show="theme === 'dark'" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                        </svg>
                        <!-- Auto icon -->
                        <svg x-show="theme === 'auto'" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak class="absolute right-0 mt-2 w-36 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 dark:ring-gray-700 focus:outline-none z-50">
                        <div class="py-1">
                            <button @click="theme = 'light'; open = false" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" :class="{ 'bg-gray-100 dark:bg-gray-700': theme === 'light' }">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                                </svg>
                                Light
                            </button>
                            <button @click="theme = 'dark'; open = false" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" :class="{ 'bg-gray-100 dark:bg-gray-700': theme === 'dark' }">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                                </svg>
                                Dark
                            </button>
                            <button @click="theme = 'auto'; open = false" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700" :class="{ 'bg-gray-100 dark:bg-gray-700': theme === 'auto' }">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25" />
                                </svg>
                                Auto
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Settings -->
                <a href="/settings" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span class="sr-only">Settings</span>
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </a>
                <!-- Profile dropdown -->
                <div class="relative" x-data="{ open: false, showProfileModal: false }">
                    <button @click="open = !open" type="button" class="flex items-center gap-1 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors cursor-pointer">
                        <span x-ref="usernameDisplay">{{.User.Username}}</span>
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    <div x-show="open" @click.away="open = false" x-cloak class="absolute right-0 mt-2 w-48 origin-top-right rounded-md bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 dark:ring-gray-700 focus:outline-none z-50">
                        <div class="py-1">
                            <button @click="showProfileModal = true; open = false" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                                </svg>
                                Edit Profile
                            </button>
                            <a href="/logout" class="flex w-full items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                                </svg>
                                Logout
                            </a>
                        </div>
                    </div>

                    <!-- Profile Modal -->
                    <div x-show="showProfileModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
                        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                            <div x-show="showProfileModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-75 transition-opacity" @click="showProfileModal = false"></div>
                            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                            <div x-show="showProfileModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100" x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" class="relative inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6" x-data="profileModal('{{.User.Username}}')" @click.away="showProfileModal = false">
                                <div class="absolute top-0 right-0 pt-4 pr-4">
                                    <button type="button" @click="showProfileModal = false" class="rounded-md bg-white dark:bg-gray-800 text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                                        <span class="sr-only">Close</span>
                                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div>
                                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modal-title">Edit Profile</h3>

                                    <!-- Tabs -->
                                    <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                                        <nav class="-mb-px flex space-x-8">
                                            <button @click="activeTab = 'username'" :class="activeTab === 'username' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                                Change Username
                                            </button>
                                            <button @click="activeTab = 'password'" :class="activeTab === 'password' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:border-gray-300'" class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                                Change Password
                                            </button>
                                        </nav>
                                    </div>

                                    <!-- Username Tab -->
                                    <div x-show="activeTab === 'username'">
                                        <form @submit.prevent="updateUsername" class="space-y-4">
                                            <div>
                                                <label for="new_username" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200">New Username</label>
                                                <div class="mt-2">
                                                    <input type="text" id="new_username" x-model="newUsername" minlength="3" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 dark:text-gray-100 dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                </div>
                                            </div>
                                            <div x-show="usernameError" class="rounded-md bg-red-50 dark:bg-red-900/50 p-3">
                                                <p class="text-sm text-red-700 dark:text-red-200" x-text="usernameError"></p>
                                            </div>
                                            <div x-show="usernameSuccess" class="rounded-md bg-green-50 dark:bg-green-900/50 p-3">
                                                <p class="text-sm text-green-700 dark:text-green-200" x-text="usernameSuccess"></p>
                                            </div>
                                            <button type="submit" :disabled="usernameLoading" class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                                <span x-show="!usernameLoading">Update Username</span>
                                                <span x-show="usernameLoading">Updating...</span>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- Password Tab -->
                                    <div x-show="activeTab === 'password'">
                                        <form @submit.prevent="updatePassword" class="space-y-4">
                                            <div>
                                                <label for="current_password" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200">Current Password</label>
                                                <div class="mt-2">
                                                    <input type="password" id="current_password" x-model="currentPassword" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 dark:text-gray-100 dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                </div>
                                            </div>
                                            <div>
                                                <label for="new_password" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200">New Password</label>
                                                <div class="mt-2">
                                                    <input type="password" id="new_password" x-model="newPassword" minlength="8" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 dark:text-gray-100 dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                </div>
                                            </div>
                                            <div>
                                                <label for="confirm_password" class="block text-sm font-medium leading-6 text-gray-900 dark:text-gray-200">Confirm New Password</label>
                                                <div class="mt-2">
                                                    <input type="password" id="confirm_password" x-model="confirmPassword" minlength="8" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 dark:text-gray-100 dark:bg-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                                                </div>
                                            </div>
                                            <div x-show="passwordError" class="rounded-md bg-red-50 dark:bg-red-900/50 p-3">
                                                <p class="text-sm text-red-700 dark:text-red-200" x-text="passwordError"></p>
                                            </div>
                                            <div x-show="passwordSuccess" class="rounded-md bg-green-50 dark:bg-green-900/50 p-3">
                                                <p class="text-sm text-green-700 dark:text-green-200" x-text="passwordSuccess"></p>
                                            </div>
                                            <button type="submit" :disabled="passwordLoading" class="flex w-full justify-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                                <span x-show="!passwordLoading">Update Password</span>
                                                <span x-show="passwordLoading">Updating...</span>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main content area with sidebar -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar for mobile -->
            <div x-show="sidebarOpen" class="relative z-40 lg:hidden" x-cloak>
                <div x-show="sidebarOpen" class="fixed inset-0 bg-gray-900/80" @click="sidebarOpen = false"></div>
                <div class="fixed inset-y-16 left-0 flex w-full max-w-xs">
                    <div x-show="sidebarOpen" class="relative flex w-full flex-col">
                        <div class="absolute right-0 top-0 -mr-12 pt-2">
                            <button type="button" class="ml-1 flex h-10 w-10 items-center justify-center rounded-full" @click="sidebarOpen = false">
                                <span class="sr-only">Close sidebar</span>
                                <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        {{template "sidebar" .}}
                    </div>
                </div>
            </div>

            <!-- Static sidebar for desktop - fixed height, doesn't grow with content -->
            <div class="hidden lg:fixed lg:inset-y-16 lg:flex lg:w-72 lg:flex-col">
                {{template "sidebar" .}}
            </div>

            <!-- Main content - offset for fixed sidebar -->
            <main class="flex-1 overflow-y-auto lg:ml-72">
                <div class="py-10 px-4 sm:px-6 lg:px-8">
                    {{template "content" .}}
                </div>
            </main>
        </div>
    </div>
    {{else}}
    {{template "content" .}}
    {{end}}

    <!-- Shared Alert Modal -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <div class="flex items-start">
                <div class="flex-shrink-0" id="alert-modal-icon"></div>
                <div class="ml-3 flex-1">
                    <h3 id="alert-modal-title" class="text-lg font-medium text-gray-900 dark:text-white"></h3>
                    <div class="mt-2" id="alert-modal-body"></div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button type="button" onclick="hideAlertModal()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
    // Shared modal icons
    const alertModalIcons = {
        error: '<svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
        warning: '<svg class="h-6 w-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
        success: '<svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>',
        info: '<svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
    };

    // Show alert modal with type: 'error', 'warning', 'success', 'info'
    // content can be a string or an array of strings (rendered as list)
    function showAlertModal(type, title, content) {
        const modal = document.getElementById('alert-modal');
        const iconEl = document.getElementById('alert-modal-icon');
        const titleEl = document.getElementById('alert-modal-title');
        const bodyEl = document.getElementById('alert-modal-body');

        if (!modal) return;

        iconEl.innerHTML = alertModalIcons[type] || alertModalIcons.info;
        titleEl.textContent = title;

        if (Array.isArray(content)) {
            bodyEl.innerHTML = '<ul class="text-sm text-gray-600 dark:text-gray-300 list-disc pl-5 space-y-1">' +
                content.map(item => '<li>' + item + '</li>').join('') + '</ul>';
        } else {
            bodyEl.innerHTML = '<p class="text-sm text-gray-600 dark:text-gray-300">' + content + '</p>';
        }

        modal.classList.remove('hidden');
    }

    function hideAlertModal() {
        const modal = document.getElementById('alert-modal');
        if (modal) modal.classList.add('hidden');
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') hideAlertModal();
    });

    // Close modal on backdrop click
    document.getElementById('alert-modal')?.addEventListener('click', function(e) {
        if (e.target === this) hideAlertModal();
    });
    </script>

    <!-- Toast Container (fixed, outside scrolling content) -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Hidden flash data for JS -->
    {{if .Flash}}<div id="flash-success" data-message="{{.Flash}}" class="hidden"></div>{{end}}
    {{if .FlashErr}}<div id="flash-error" data-message="{{.FlashErr}}" class="hidden"></div>{{end}}

    <script>
    function showToast(success, message) {
        const container = document.getElementById('toast-container');
        const id = 'toast-' + Date.now();
        const bgClass = success ? 'bg-green-50 dark:bg-green-900/90' : 'bg-red-50 dark:bg-red-900/90';
        const textClass = success ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200';
        const iconColor = success ? 'text-green-400' : 'text-red-400';
        const icon = success
            ? '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />'
            : '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" />';

        const toast = document.createElement('div');
        toast.id = id;
        toast.className = `${bgClass} rounded-lg shadow-lg p-4 max-w-sm flex items-start gap-3 transform transition-all duration-300 translate-x-0 opacity-100`;
        toast.innerHTML = `
            <svg class="h-5 w-5 ${iconColor} flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">${icon}</svg>
            <p class="text-sm font-medium ${textClass} flex-1">${message}</p>
            <button onclick="hideToast('${id}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>`;
        container.appendChild(toast);
        setTimeout(() => hideToast(id), success ? 4000 : 6000);
    }

    function hideToast(id) {
        const toast = document.getElementById(id);
        if (toast) {
            toast.classList.add('opacity-0', 'translate-x-8');
            setTimeout(() => toast.remove(), 300);
        }
    }

    // Init toasts from server flash messages
    document.addEventListener('DOMContentLoaded', function() {
        const flashSuccess = document.getElementById('flash-success');
        const flashError = document.getElementById('flash-error');
        if (flashSuccess) {
            showToast(true, flashSuccess.dataset.message);
        }
        if (flashError) {
            showToast(false, flashError.dataset.message);
        }
    });
    </script>
</body>
</html>
{{end}}

{{define "sidebar"}}
<div class="flex grow flex-col gap-y-5 overflow-y-auto bg-gray-900 px-6 py-4">
    <nav class="flex flex-1 flex-col">
        <ul role="list" class="flex flex-1 flex-col gap-y-7">
            <li>
                <ul role="list" class="-mx-2 space-y-1">
                    <li>
                        <a href="/" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    {{if or .ScanningEnabled .UploadsEnabled}}
                    <li>
                        <a href="/triggers" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                            </svg>
                            Triggers
                        </a>
                    </li>
                    {{end}}
                    {{if .ScanningEnabled}}
                    <li>
                        <a href="/targets" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7m0 0a3 3 0 01-3 3m0 3h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008zm-3 6h.008v.008h-.008v-.008zm0-6h.008v.008h-.008v-.008z" />
                            </svg>
                            Targets
                        </a>
                    </li>
                    {{end}}
                    {{if .UploadsEnabled}}
                    <li>
                        <a href="/uploads" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                            </svg>
                            Uploads
                        </a>
                    </li>
                    {{end}}
                </ul>
            </li>
            <li>
                <div class="text-xs font-semibold leading-6 text-gray-400">History</div>
                <ul role="list" class="-mx-2 mt-2 space-y-1">
                    {{if .ScanningEnabled}}
                    <li>
                        <a href="/history/scans" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            Scan History
                        </a>
                    </li>
                    {{end}}
                    {{if .UploadsEnabled}}
                    <li>
                        <a href="/history/uploads" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            Upload History
                        </a>
                    </li>
                    {{end}}
                </ul>
            </li>
            {{if .UploadsEnabled}}
            <li>
                <div class="text-xs font-semibold leading-6 text-gray-400">Tools</div>
                <ul role="list" class="-mx-2 mt-2 space-y-1">
                    <li>
                        <a href="/rclone" class="group flex gap-x-3 rounded-md p-2 text-sm font-semibold leading-6 text-gray-400 hover:bg-gray-800 hover:text-white">
                            <svg class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5" />
                            </svg>
                            Rclone Explorer
                        </a>
                    </li>
                </ul>
            </li>
            {{end}}
        </ul>
    </nav>
</div>
{{end}}
