{{define "content"}}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Upload Configuration</h1>
        <p class="mt-2 text-sm text-gray-700 dark:text-gray-300">Configure cloud remotes and destinations for rclone uploads.</p>
    </div>

    <!-- Tabs -->
    <div class="border-b border-gray-200 dark:border-gray-700">
        <nav class="-mb-px flex space-x-8">
            <a href="/uploads" class="{{if eq .Content.Tab "queue"}}border-indigo-500 text-indigo-600 dark:text-indigo-400{{else}}border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-300{{end}} whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Queue</a>
            <a href="/uploads/remotes" class="{{if eq .Content.Tab "remotes"}}border-indigo-500 text-indigo-600 dark:text-indigo-400{{else}}border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-300{{end}} whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Remotes</a>
            <a href="/uploads/destinations" class="{{if eq .Content.Tab "destinations"}}border-indigo-500 text-indigo-600 dark:text-indigo-400{{else}}border-transparent text-gray-500 dark:text-gray-400 hover:border-gray-300 dark:hover:border-gray-600 hover:text-gray-700 dark:hover:text-gray-300{{end}} whitespace-nowrap border-b-2 py-4 px-1 text-sm font-medium">Destinations</a>
        </nav>
    </div>

    {{if eq .Content.Tab "queue"}}
    {{if not .Content.HasLocalTriggers}}
    <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-4 text-sm text-yellow-800 dark:text-yellow-200">
        Uploads require at least one local trigger (inotify or polling). <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create a trigger</a> to enable uploads.
    </div>
    {{end}}
    <!-- Active Transfers Section -->
    <div id="active-transfers" hx-get="/uploads/active" hx-trigger="load, sse-refresh" hx-swap="innerHTML">
        {{template "active_transfers" .Content.ActiveTransfers}}
    </div>

    <!-- Queue Tab -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <div>
                <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Upload Queue</h3>
                <p id="upload-queue-stats" class="text-sm text-gray-500 dark:text-gray-400 mt-1" hx-get="/uploads/queue-stats" hx-trigger="load, sse-refresh" hx-swap="innerHTML" data-sse-polling-fallback="5s">
                    {{template "upload_queue_stats" .Content}}
                </p>
            </div>
            <div class="flex items-center gap-3">
                {{if .Content.IsPaused}}
                <form method="POST" action="/uploads/resume" class="inline">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Resume
                    </button>
                </form>
                {{else}}
                <form method="POST" action="/uploads/pause" class="inline">
                    <button type="submit" class="inline-flex items-center gap-2 rounded-md bg-amber-400 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-amber-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-amber-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Pause
                    </button>
                </form>
                {{end}}
            </div>
        </div>
        <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Path</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Remote</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Size</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody id="upload-queue" hx-get="/uploads/queue?page={{.Content.Page}}&pageSize={{.Content.PageSize}}" hx-trigger="load, sse-refresh" hx-swap="innerHTML" data-sse-polling-fallback="3s" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {{template "upload_queue" .Content.Uploads}}
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div id="upload-queue-pagination" hx-get="/uploads/queue-pagination?page={{.Content.Page}}&pageSize={{.Content.PageSize}}" hx-trigger="load, sse-refresh" hx-swap="innerHTML" data-sse-polling-fallback="5s">
            {{template "upload_queue_pagination" .Content}}
        </div>
    </div>

    {{else if eq .Content.Tab "remotes"}}
    <!-- Remotes Tab -->
    {{if .Content.IsNew}}
    <!-- New Remote Form -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">New Remote</h3>
        </div>
        <form method="POST" action="/uploads/remotes" class="p-6 space-y-4">
            {{if not .Content.HasLocalTriggers}}
            <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-4 text-sm text-yellow-800 dark:text-yellow-200">
                A local trigger (inotify or polling) is required before configuring uploads. <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create a trigger</a>.
            </div>
            {{end}}
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                <input type="text" name="name" id="name" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            </div>
            <div>
                <label for="rclone_remote" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rclone Remote</label>
                {{if .Content.AvailableRemotes}}
                <select name="rclone_remote" id="rclone_remote" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    {{range .Content.AvailableRemotes}}
                    <option value="{{.}}:">{{.}}</option>
                    {{end}}
                </select>
                {{else}}
                <input type="text" name="rclone_remote" id="rclone_remote" placeholder="gdrive:" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Enter the rclone remote name (e.g., gdrive:, dropbox:)</p>
                {{end}}
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="enabled" id="enabled" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Enabled</label>
            </div>

            <!-- Transfer Options -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Transfer Options</h4>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Add backend types to see available options. Click an option to add it to this remote's configuration.</p>

                <!-- Added options will appear here -->
                <div id="configured-options" class="space-y-2 mb-4"></div>

                <!-- Add Backend Type -->
                {{if .Content.Providers}}
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Add backend options</label>
                        <select onchange="showBackendPanel(this.value)" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                            <option value="">Select a backend type to add...</option>
                            {{range .Content.Providers}}
                            <option value="{{.Name}}">{{.Name}} - {{truncate .Description 50}}</option>
                            {{end}}
                        </select>
                    </div>

                    <!-- Backend options panels (pre-rendered, hidden by default) -->
                    <div id="backend-options-container">
                        {{range $provider := .Content.Providers}}
                        <div id="backend-panel-{{$provider.Name}}" class="hidden border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden">
                            <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 flex justify-between items-center">
                                <h5 class="text-sm font-medium text-gray-900 dark:text-white">{{$provider.Name}} Options</h5>
                                <button type="button" onclick="hideBackendPanel()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            <div class="max-h-80 overflow-y-auto">{{range $provider.Options}}
                                <button type="button" onclick="addOption('{{$provider.Name}}', '{{.Name}}', '{{jsEscape .DefaultStr}}', '{{jsEscape .Help}}', '{{.Type}}', '{{typeChoices .Type}}')"
                                    class="w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100 dark:hover:bg-gray-600 flex justify-between items-start group border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                                    <div class="flex-1 min-w-0">
                                        <span class="font-medium text-gray-700 dark:text-gray-300">{{.Name}}</span>
                                        {{if .Advanced}}<span class="text-orange-500 dark:text-orange-400 ml-1 text-xs">(adv)</span>{{end}}
                                        {{if .DefaultStr}}<span class="text-gray-400 ml-1">(default: {{.DefaultStr}})</span>{{end}}
                                        <p class="text-gray-500 dark:text-gray-400 truncate text-xs">{{truncate .Help 80}}</p>
                                    </div>
                                    <span class="text-indigo-600 dark:text-indigo-400 opacity-0 group-hover:opacity-100 ml-2">+ Add</span>
                                </button>{{end}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <p class="text-xs text-yellow-600 dark:text-yellow-400">Rclone is not running. Start rclone to see available options.</p>
                {{end}}
            </div>

            <div class="flex justify-end space-x-3">
                <a href="/uploads/remotes" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Cancel</a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 {{if not .Content.HasLocalTriggers}}opacity-50 cursor-not-allowed{{end}}" {{if not .Content.HasLocalTriggers}}disabled{{end}}>Create Remote</button>
            </div>
        </form>
    </div>
    {{else if .Content.Remote}}
    <!-- Edit Remote Form -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Edit Remote</h3>
        </div>
        <form method="POST" action="/uploads/remotes/{{.Content.Remote.ID}}" class="p-6 space-y-4">
            <input type="hidden" name="_method" value="PUT">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Name</label>
                <input type="text" name="name" id="name" value="{{.Content.Remote.Name}}" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            </div>
            <div>
                <label for="rclone_remote" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rclone Remote</label>
                <input type="text" name="rclone_remote" id="rclone_remote" value="{{.Content.Remote.RcloneRemote}}" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="enabled" id="enabled" {{if .Content.Remote.Enabled}}checked{{end}} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Enabled</label>
            </div>

            <!-- Transfer Options -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">Transfer Options</h4>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Add backend types to see available options. Click an option to add it to this remote's configuration.</p>

                <!-- Configured options (grouped by backend) -->
                <div id="configured-options" class="space-y-3 mb-4">
                    {{if .Content.Remote.TransferOptions}}
                    <div id="opt-group-existing" class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden">
                        <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 flex justify-between items-center">
                            <h5 class="text-sm font-medium text-gray-900 dark:text-white">Saved Options</h5>
                            <button type="button" onclick="removeBackendGroup('existing')" class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 text-xs">Remove All</button>
                        </div>
                        <div class="p-3 space-y-3" id="opt-group-content-existing">
                            {{range $key, $value := .Content.Remote.TransferOptions}}
                            <div class="bg-white dark:bg-gray-600 p-3 rounded shadow-sm space-y-2" id="opt-row-{{$key}}">
                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">{{$key}}</label>
                                    <button type="button" onclick="removeOption('{{$key}}', 'existing')" class="text-red-600 hover:text-red-800 dark:text-red-400 text-xs">Remove</button>
                                </div>
                                <input type="text" name="opt_{{$key}}" value="{{$value}}" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-500 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1.5 border">
                                <p class="text-xs text-gray-500 dark:text-gray-400 italic">Select this option from a backend below to see its description.</p>
                            </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>

                <!-- Add Backend Type -->
                {{if .Content.Providers}}
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Add backend options</label>
                        <select onchange="showBackendPanel(this.value)" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                            <option value="">Select a backend type to add...</option>
                            {{range .Content.Providers}}
                            <option value="{{.Name}}">{{.Name}} - {{truncate .Description 50}}</option>
                            {{end}}
                        </select>
                    </div>

                    <!-- Backend options panels (pre-rendered, hidden by default) -->
                    <div id="backend-options-container">
                        {{range $provider := .Content.Providers}}
                        <div id="backend-panel-{{$provider.Name}}" class="hidden border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden">
                            <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 flex justify-between items-center">
                                <h5 class="text-sm font-medium text-gray-900 dark:text-white">{{$provider.Name}} Options</h5>
                                <button type="button" onclick="hideBackendPanel()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                            <div class="max-h-80 overflow-y-auto">{{range $provider.Options}}
                                <button type="button" onclick="addOption('{{$provider.Name}}', '{{.Name}}', '{{jsEscape .DefaultStr}}', '{{jsEscape .Help}}', '{{.Type}}', '{{typeChoices .Type}}')"
                                    class="w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100 dark:hover:bg-gray-600 flex justify-between items-start group border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                                    <div class="flex-1 min-w-0">
                                        <span class="font-medium text-gray-700 dark:text-gray-300">{{.Name}}</span>
                                        {{if .Advanced}}<span class="text-orange-500 dark:text-orange-400 ml-1 text-xs">(adv)</span>{{end}}
                                        {{if .DefaultStr}}<span class="text-gray-400 ml-1">(default: {{.DefaultStr}})</span>{{end}}
                                        <p class="text-gray-500 dark:text-gray-400 truncate text-xs">{{truncate .Help 80}}</p>
                                    </div>
                                    <span class="text-indigo-600 dark:text-indigo-400 opacity-0 group-hover:opacity-100 ml-2">+ Add</span>
                                </button>{{end}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <p class="text-xs text-yellow-600 dark:text-yellow-400">Rclone is not running. Start rclone to see available options.</p>
                {{end}}
            </div>

            <div class="flex justify-end space-x-3">
                <a href="/uploads/remotes" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Cancel</a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Update Remote</button>
            </div>
        </form>
    </div>
    {{else}}
    <!-- Remotes List -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Rclone Remotes</h3>
            {{if .Content.HasLocalTriggers}}
            <a href="/uploads/remotes/new" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add Remote</a>
            {{else}}
            <span class="text-sm text-gray-500 dark:text-gray-400">Add a local trigger to enable remotes</span>
            {{end}}
        </div>
        <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Rclone Remote</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {{if .Content.Remotes}}
                    {{range .Content.Remotes}}
                    <tr id="remote-{{.ID}}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">{{.Name}}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{.RcloneRemote}}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {{if .Enabled}}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Enabled</span>
                            {{else}}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Disabled</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end gap-2">
                                <button onclick="testRemote(this, {{.ID}})" class="btn-primary text-sm bg-green-600 hover:bg-green-500 focus-visible:outline-green-600">Test</button>
                                <a href="/uploads/remotes/{{.ID}}" class="btn-primary text-sm">Edit</a>
                                <button hx-delete="/uploads/remotes/{{.ID}}" hx-target="#remote-{{.ID}}" hx-swap="outerHTML" hx-confirm="Are you sure you want to delete this remote?" class="btn-danger text-sm">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                    {{else}}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-center">
                            {{if .Content.HasLocalTriggers}}
                                No remotes configured. <a href="/uploads/remotes/new" class="text-indigo-600 hover:text-indigo-900">Add one</a>
                            {{else}}
                                No remotes configured. Create a local trigger first.
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>

    <script>
    async function testRemote(btn, id) {
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Testing...';
        try {
            const response = await fetch('/uploads/remotes/' + id + '/test', { method: 'POST' });
            const data = await response.json();
            showToast(data.success, data.message);
        } catch (error) {
            showToast(false, 'Failed to test: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }
    </script>
    {{end}}

    {{else if eq .Content.Tab "destinations"}}
    <!-- Destinations Tab -->
    {{if .Content.IsNew}}
    <!-- New Destination Form -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">New Destination</h3>
        </div>
        <form method="POST" action="/uploads/destinations" id="new-destination-form" class="p-6 space-y-4">
            {{if not .Content.HasLocalTriggers}}
            <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-4 text-sm text-yellow-800 dark:text-yellow-200">
                A local trigger (inotify or polling) is required before configuring uploads. <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create a trigger</a>.
            </div>
            {{end}}
            <div>
                <label for="local_path" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Local Path</label>
                <input type="text" name="local_path" id="local_path" placeholder="/mnt/local/Media" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Each destination must have a unique local path.</p>
                <p id="local_path_error_new" class="mt-1 text-xs text-red-600 dark:text-red-400 hidden">This local path is already used by another destination.</p>
            </div>
            <div>
                <label for="min_file_age_minutes_new" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum File Age (minutes)</label>
                <input type="number" name="min_file_age_minutes" id="min_file_age_minutes_new" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">0 disables. Uses filesystem mtime.</p>
            </div>
            <div>
                <label for="min_folder_size_gb_new" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload Folder Total Size (GB)</label>
                <input type="number" name="min_folder_size_gb" id="min_folder_size_gb_new" min="0" value="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">0 disables. If both age and size are set, size is the primary wait reason but both must pass.</p>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center">
                    <input type="checkbox" name="use_plex_scan_tracking" id="use_plex_scan_tracking_new" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="use_plex_scan_tracking_new" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Use Plex scan tracking (overrides delay checks)</label>
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Wait for Plex scans to finish before uploads start. Configure per Plex target idle thresholds below.</p>
                <div id="plex-tracking-panel-new" class="hidden mt-4 space-y-3">
                    {{if .Content.PlexTargets}}
                    {{range .Content.PlexTargets}}
                    <div class="plex-target-row flex flex-col gap-2 rounded-md border border-gray-200 dark:border-gray-700 p-3" data-plex-target-row>
                        <label class="flex items-center">
                            <input type="checkbox" name="plex_target_ids[]" value="{{.ID}}" data-plex-name="{{.Name}}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">{{.Name}}</span>
                        </label>
                        <div>
                            <label for="plex_idle_threshold_{{.ID}}_new" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Idle Threshold (seconds)</label>
                            <input type="number" name="plex_idle_threshold_{{.ID}}" id="plex_idle_threshold_{{.ID}}_new" min="1" value="30" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border" data-plex-idle>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No Plex targets configured. <a href="/targets/new" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Add a Plex target</a> first.</p>
                    {{end}}
                    <div id="plex-concurrency-warning-new" class="hidden rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-3 text-sm text-yellow-800 dark:text-yellow-200">
                        <strong>Scan concurrency warning:</strong> processor.max_concurrent_scans is set to {{.Content.ProcessorMaxConcurrentScans}}. Consider setting it between 1 and 3 when Plex tracking is enabled.
                    </div>
                </div>
            </div>
            <div>
                <label for="transfer_type_new" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Transfer Type</label>
                <select name="transfer_type" id="transfer_type_new" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <option value="move" selected>Move (delete after upload)</option>
                    <option value="copy">Copy (keep original)</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="enabled" id="enabled" checked class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Enabled</label>
            </div>

            <!-- Exclude Paths -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Paths</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Path prefixes to exclude from uploads</p>
                    </div>
                    <button type="button" id="add-exclude-path" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Path
                    </button>
                </div>
                <div id="exclude-paths-container" class="space-y-3"></div>
            </div>

            <!-- Exclude Extensions -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Extensions</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">File extensions to exclude from uploads</p>
                    </div>
                    <button type="button" id="add-exclude-extension" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Extension
                    </button>
                </div>
                <div id="exclude-extensions-container" class="space-y-3"></div>
            </div>

            <!-- Advanced Filters (Regex) -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Advanced Filters (Regex)</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use regex patterns for fine-grained control. Include patterns whitelist paths (path must match one). Exclude patterns blacklist paths (matching paths are skipped).</p>
                </div>

                <!-- Include Patterns -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Include Patterns (whitelist)</label>
                        <button type="button" id="add-adv-include-pattern" class="btn-secondary text-xs">Add Include Pattern</button>
                    </div>
                    <div id="adv-include-patterns-container" class="space-y-2"></div>
                </div>

                <!-- Exclude Patterns -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Exclude Patterns (blacklist)</label>
                        <button type="button" id="add-adv-exclude-pattern" class="btn-secondary text-xs">Add Exclude Pattern</button>
                    </div>
                    <div id="adv-exclude-patterns-container" class="space-y-2"></div>
                </div>
            </div>

            <!-- Remote Destinations -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Remote Destinations</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">First remote is primary, others are failover. Drag to reorder.</p>
                    </div>
                    {{if .Content.Remotes}}
                    <button type="button" id="add-new-path-remote" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Remote
                    </button>
                    {{end}}
                </div>
                <div id="new-path-remotes-container" class="space-y-3"></div>
                {{if not .Content.Remotes}}
                <p class="text-sm text-gray-500 dark:text-gray-400">No remotes configured. <a href="/uploads/remotes/new" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create one first</a>.</p>
                {{end}}
            </div>

            <!-- Included Triggers -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Allowed Triggers</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Only files from selected local triggers (inotify/polling) will be uploaded to this destination. At least one must be selected.</p>
                </div>
                {{if .Content.LocalTriggers}}
                <div class="space-y-2">
                    {{range .Content.LocalTriggers}}
                    <label class="flex items-center">
                        <input type="checkbox" name="included_triggers[]" value="{{.ID}}" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">{{.Name}}</span>
                        <span class="ml-2 text-xs px-1.5 py-0.5 rounded {{if eq .Type "inotify"}}bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-400{{else}}bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-400{{end}}">{{.Type}}</span>
                    </label>
                    {{end}}
                </div>
                {{else}}
                <p class="text-sm text-gray-500 dark:text-gray-400">No local triggers configured. <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create one first</a>.</p>
                {{end}}
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <a href="/uploads/destinations" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Cancel</a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 {{if not .Content.HasLocalTriggers}}opacity-50 cursor-not-allowed{{end}}" {{if not .Content.HasLocalTriggers}}disabled{{end}}>Create Destination</button>
            </div>
        </form>
    </div>
    <script>
    (function() {
        const existingDestinationPaths = [
            {{range .Content.Destinations}}"{{jsEscape .LocalPath}}",{{end}}
        ];
        const currentDestinationPath = '';
        const localPathInput = document.getElementById('local_path');
        const localPathError = document.getElementById('local_path_error_new');

        function normalizePath(value) {
            if (!value) return '';
            let normalized = value.trim().replace(/\\/g, '/');
            if (normalized.length > 1) {
                normalized = normalized.replace(/\/+$/, '');
            }
            return normalized;
        }

        const normalizedExistingPaths = existingDestinationPaths.map(normalizePath);
        const normalizedCurrentPath = normalizePath(currentDestinationPath);

        function isDuplicatePath(value) {
            const normalized = normalizePath(value);
            if (!normalized) return false;
            if (normalizedCurrentPath && normalized === normalizedCurrentPath) {
                return false;
            }
            return normalizedExistingPaths.includes(normalized);
        }

        function updateLocalPathWarning() {
            if (!localPathInput || !localPathError) return true;
            const duplicate = isDuplicatePath(localPathInput.value);
            localPathError.classList.toggle('hidden', !duplicate);
            return !duplicate;
        }

        if (localPathInput) {
            localPathInput.addEventListener('input', updateLocalPathWarning);
            localPathInput.addEventListener('blur', updateLocalPathWarning);
        }

        const plexToggle = document.getElementById('use_plex_scan_tracking_new');
        const plexPanel = document.getElementById('plex-tracking-panel-new');
        const plexWarning = document.getElementById('plex-concurrency-warning-new');
        const maxConcurrentScans = parseInt('{{.Content.ProcessorMaxConcurrentScans}}', 10) || 0;

        function updatePlexRows() {
            const rows = document.querySelectorAll('[data-plex-target-row]');
            rows.forEach((row) => {
                const checkbox = row.querySelector('input[name="plex_target_ids[]"]');
                const idleInput = row.querySelector('[data-plex-idle]');
                if (!checkbox || !idleInput) return;
                const enabled = plexToggle && plexToggle.checked && checkbox.checked;
                idleInput.disabled = !enabled;
                idleInput.classList.toggle('opacity-50', !enabled);
            });
        }

        function updatePlexPanel() {
            if (!plexToggle || !plexPanel) return;
            const enabled = plexToggle.checked;
            plexPanel.classList.toggle('hidden', !enabled);
            if (plexWarning) {
                const showWarning = enabled && (maxConcurrentScans === 0 || maxConcurrentScans >= 4);
                plexWarning.classList.toggle('hidden', !showWarning);
            }
            updatePlexRows();
        }

        if (plexToggle) {
            plexToggle.addEventListener('change', updatePlexPanel);
            document.querySelectorAll('input[name="plex_target_ids[]"]').forEach((checkbox) => {
                checkbox.addEventListener('change', updatePlexRows);
            });
            updatePlexPanel();
        }

        // Exclude paths management
        const excludePathsContainer = document.getElementById('exclude-paths-container');
        const addExcludePathBtn = document.getElementById('add-exclude-path');

        function createExcludePathRow(path = '') {
            const row = document.createElement('div');
            row.className = 'exclude-path-row flex items-center gap-3';
            row.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="exclude_paths[]" value="${path}" placeholder="Path prefix to exclude (e.g., /mnt/media/temp)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-exclude-path text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addExcludePathBtn) {
            addExcludePathBtn.addEventListener('click', function() {
                excludePathsContainer.appendChild(createExcludePathRow());
            });
        }

        if (excludePathsContainer) {
            excludePathsContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-exclude-path')) {
                    e.target.closest('.exclude-path-row').remove();
                }
            });
        }

        // Exclude extensions management
        const excludeExtContainer = document.getElementById('exclude-extensions-container');
        const addExcludeExtBtn = document.getElementById('add-exclude-extension');

        function createExcludeExtRow(ext = '') {
            const row = document.createElement('div');
            row.className = 'exclude-ext-row flex items-center gap-3';
            row.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="exclude_extensions[]" value="${ext}" placeholder="Extension to exclude (e.g., .tmp)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-exclude-ext text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addExcludeExtBtn) {
            addExcludeExtBtn.addEventListener('click', function() {
                excludeExtContainer.appendChild(createExcludeExtRow());
            });
        }

        if (excludeExtContainer) {
            excludeExtContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-exclude-ext')) {
                    e.target.closest('.exclude-ext-row').remove();
                }
            });
        }

        // Advanced filters management (new destination form)
        function createAdvPatternRow(name, value = '') {
            const row = document.createElement('div');
            row.className = 'adv-pattern-row flex items-center gap-2';
            row.innerHTML = `
                <input type="text" name="${name}" value="${value}" placeholder="Regex pattern (e.g., \\.mkv$)"
                    class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                <button type="button" class="remove-adv-pattern text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            return row;
        }

        const advIncludeContainer = document.getElementById('adv-include-patterns-container');
        const advExcludeContainer = document.getElementById('adv-exclude-patterns-container');
        const addAdvIncludeBtn = document.getElementById('add-adv-include-pattern');
        const addAdvExcludeBtn = document.getElementById('add-adv-exclude-pattern');

        if (addAdvIncludeBtn && advIncludeContainer) {
            addAdvIncludeBtn.addEventListener('click', function() {
                advIncludeContainer.appendChild(createAdvPatternRow('advanced_include_patterns[]'));
            });
        }

        if (addAdvExcludeBtn && advExcludeContainer) {
            addAdvExcludeBtn.addEventListener('click', function() {
                advExcludeContainer.appendChild(createAdvPatternRow('advanced_exclude_patterns[]'));
            });
        }

        // Remove pattern handlers
        [advIncludeContainer, advExcludeContainer].forEach(cont => {
            if (cont) {
                cont.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-adv-pattern')) {
                        e.target.closest('.adv-pattern-row').remove();
                    }
                });
            }
        });

        // Remote destinations management
        const remotesData = [
            {{range .Content.Remotes}}
            { id: {{.ID}}, name: "{{.Name}}" },
            {{end}}
        ];

        const container = document.getElementById('new-path-remotes-container');
        const addBtn = document.getElementById('add-new-path-remote');

        function createRemoteMappingRow(remoteId = '', remotePath = '') {
            const row = document.createElement('div');
            row.className = 'remote-mapping-row flex items-center gap-3';

            const optionsHtml = remotesData.map(r =>
                `<option value="${r.id}" ${r.id == remoteId ? 'selected' : ''}>${r.name}</option>`
            ).join('');

            row.innerHTML = `
                <svg class="w-4 h-4 text-gray-400 cursor-move handle flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                <div class="w-48 flex-shrink-0">
                    <select name="remote_ids[]" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        ${optionsHtml}
                    </select>
                </div>
                <span class="text-gray-500 dark:text-gray-400 flex-shrink-0"></span>
                <div class="flex-1">
                    <input type="text" name="remote_paths[]" value="${remotePath}" placeholder="Remote path (e.g., /Media/TV)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-remote-mapping text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addBtn) {
            addBtn.addEventListener('click', function() {
                container.appendChild(createRemoteMappingRow());
            });
        }

        if (container) {
            container.addEventListener('click', function(e) {
                if (e.target.closest('.remove-remote-mapping')) {
                    e.target.closest('.remote-mapping-row').remove();
                }
            });

            // Initialize sortable for drag-and-drop reordering
            new Sortable(container, {
                animation: 150,
                handle: '.handle'
            });
        }

        const hasLocalTriggers = {{if .Content.HasLocalTriggers}}true{{else}}false{{end}};

        // Form validation with modal popup
        const form = document.getElementById('new-destination-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const remoteSelects = form.querySelectorAll('select[name="remote_ids[]"]');
                const triggerCheckboxes = form.querySelectorAll('input[name="included_triggers[]"]:checked');
                const plexSelected = form.querySelectorAll('input[name="plex_target_ids[]"]:checked');

                const errors = [];
                if (!hasLocalTriggers) {
                    errors.push('At least one local trigger is required before configuring uploads');
                }
                if (!updateLocalPathWarning()) {
                    errors.push('Local path must be unique');
                }
                if (remoteSelects.length === 0) {
                    errors.push('At least one remote must be configured');
                }
                if (triggerCheckboxes.length === 0) {
                    errors.push('At least one trigger must be selected');
                }
                if (plexToggle && plexToggle.checked) {
                    if (plexSelected.length === 0) {
                        errors.push('Select at least one Plex target for scan tracking');
                    }
                    plexSelected.forEach((checkbox) => {
                        const idleInput = form.querySelector('input[name="plex_idle_threshold_' + checkbox.value + '"]');
                        const idleValue = idleInput ? parseInt(idleInput.value, 10) : 0;
                        if (!idleValue || idleValue <= 0) {
                            const targetName = checkbox.dataset.plexName || checkbox.value;
                            errors.push('Idle threshold must be greater than 0 for Plex target: ' + targetName);
                        }
                    });
                }

                if (errors.length > 0) {
                    e.preventDefault();
                    showAlertModal('error', 'Validation Error', errors);
                }
            });
        }
    })();
    </script>
    {{else if .Content.Destination}}
    <!-- Edit Destination Form -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Edit Destination</h3>
        </div>
        <form method="POST" action="/uploads/destinations/{{.Content.Destination.ID}}" id="edit-destination-form" class="p-6 space-y-4">
            {{if not .Content.HasLocalTriggers}}
            <div class="rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-4 text-sm text-yellow-800 dark:text-yellow-200">
                A local trigger (inotify or polling) is required before configuring uploads. <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create a trigger</a>.
            </div>
            {{end}}
            <input type="hidden" name="_method" value="PUT">
            <div>
                <label for="local_path" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Local Path</label>
                <input type="text" name="local_path" id="local_path" value="{{.Content.Destination.LocalPath}}" required class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Each destination must have a unique local path.</p>
                <p id="local_path_error_edit" class="mt-1 text-xs text-red-600 dark:text-red-400 hidden">This local path is already used by another destination.</p>
            </div>
            <div>
                <label for="min_file_age_minutes_edit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Minimum File Age (minutes)</label>
                <input type="number" name="min_file_age_minutes" id="min_file_age_minutes_edit" min="0" value="{{.Content.Destination.MinFileAgeMinutes}}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">0 disables. Uses filesystem mtime.</p>
            </div>
            <div>
                <label for="min_folder_size_gb_edit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Upload Folder Total Size (GB)</label>
                <input type="number" name="min_folder_size_gb" id="min_folder_size_gb_edit" min="0" value="{{.Content.Destination.MinFolderSizeGB}}" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">0 disables. If both age and size are set, size is the primary wait reason but both must pass.</p>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center">
                    <input type="checkbox" name="use_plex_scan_tracking" id="use_plex_scan_tracking_edit" {{if .Content.Destination.UsePlexTracking}}checked{{end}} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="use_plex_scan_tracking_edit" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Use Plex scan tracking (overrides delay checks)</label>
                </div>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">Wait for Plex scans to finish before uploads start. Configure per Plex target idle thresholds below.</p>
                <div id="plex-tracking-panel-edit" class="{{if not .Content.Destination.UsePlexTracking}}hidden{{end}} mt-4 space-y-3">
                    {{if .Content.PlexTargets}}
                    {{range $plex := .Content.PlexTargets}}
                    {{- $selected := false -}}
                    {{- $idle := 30 -}}
                    {{- if $.Content.Destination.PlexTargets -}}
                        {{- range $.Content.Destination.PlexTargets -}}
                            {{- if eq .TargetID $plex.ID -}}
                                {{- $selected = true -}}
                                {{- $idle = .IdleThresholdSeconds -}}
                            {{- end -}}
                        {{- end -}}
                    {{- end -}}
                    <div class="plex-target-row flex flex-col gap-2 rounded-md border border-gray-200 dark:border-gray-700 p-3" data-plex-target-row>
                        <label class="flex items-center">
                            <input type="checkbox" name="plex_target_ids[]" value="{{$plex.ID}}" data-plex-name="{{$plex.Name}}" {{if $selected}}checked{{end}} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">{{$plex.Name}}</span>
                        </label>
                        <div>
                            <label for="plex_idle_threshold_{{$plex.ID}}_edit" class="block text-xs font-medium text-gray-600 dark:text-gray-400">Idle Threshold (seconds)</label>
                            <input type="number" name="plex_idle_threshold_{{$plex.ID}}" id="plex_idle_threshold_{{$plex.ID}}_edit" min="1" value="{{$idle}}" class="mt-1 block w-40 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border" data-plex-idle>
                        </div>
                    </div>
                    {{end}}
                    {{else}}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No Plex targets configured. <a href="/targets/new" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Add a Plex target</a> first.</p>
                    {{end}}
                    <div id="plex-concurrency-warning-edit" class="hidden rounded-md bg-yellow-50 dark:bg-yellow-900/30 p-3 text-sm text-yellow-800 dark:text-yellow-200">
                        <strong>Scan concurrency warning:</strong> processor.max_concurrent_scans is set to {{.Content.ProcessorMaxConcurrentScans}}. Consider setting it between 1 and 3 when Plex tracking is enabled.
                    </div>
                </div>
            </div>
            <div>
                <label for="transfer_type_edit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Transfer Type</label>
                <select name="transfer_type" id="transfer_type_edit" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                    <option value="move" {{if eq .Content.Destination.TransferType "move"}}selected{{end}}>Move (delete after upload)</option>
                    <option value="copy" {{if eq .Content.Destination.TransferType "copy"}}selected{{end}}>Copy (keep original)</option>
                </select>
            </div>
            <div class="flex items-center">
                <input type="checkbox" name="enabled" id="enabled" {{if .Content.Destination.Enabled}}checked{{end}} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                <label for="enabled" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Enabled</label>
            </div>

            <!-- Exclude Paths -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Paths</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Path prefixes to exclude from uploads</p>
                    </div>
                    <button type="button" id="add-exclude-path-edit" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Path
                    </button>
                </div>
                <div id="exclude-paths-container-edit" class="space-y-3">
                    {{range .Content.Destination.ExcludePaths}}
                    <div class="exclude-path-row flex items-center gap-3">
                        <div class="flex-1">
                            <input type="text" name="exclude_paths[]" value="{{.}}" placeholder="Path prefix to exclude (e.g., /mnt/media/temp)"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        </div>
                        <button type="button" class="remove-exclude-path text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Exclude Extensions -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Exclude Extensions</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">File extensions to exclude from uploads</p>
                    </div>
                    <button type="button" id="add-exclude-extension-edit" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Extension
                    </button>
                </div>
                <div id="exclude-extensions-container-edit" class="space-y-3">
                    {{range .Content.Destination.ExcludeExtensions}}
                    <div class="exclude-ext-row flex items-center gap-3">
                        <div class="flex-1">
                            <input type="text" name="exclude_extensions[]" value="{{.}}" placeholder="Extension to exclude (e.g., .tmp)"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        </div>
                        <button type="button" class="remove-exclude-ext text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>

            <!-- Advanced Filters (Regex) -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Advanced Filters (Regex)</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Use regex patterns for fine-grained control. Include patterns whitelist paths (path must match one). Exclude patterns blacklist paths (matching paths are skipped).</p>
                </div>

                <!-- Include Patterns -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Include Patterns (whitelist)</label>
                        <button type="button" id="add-adv-include-pattern-edit" class="btn-secondary text-xs">Add Include Pattern</button>
                    </div>
                    <div id="adv-include-patterns-container-edit" class="space-y-2">
                        {{if .Content.Destination.AdvancedFilters}}
                        {{range .Content.Destination.AdvancedFilters.IncludePatterns}}
                        <div class="adv-pattern-row flex items-center gap-2">
                            <input type="text" name="advanced_include_patterns[]" value="{{.}}" placeholder="Regex pattern (e.g., \.mkv$)"
                                class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                            <button type="button" class="remove-adv-pattern text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        {{end}}
                        {{end}}
                    </div>
                </div>

                <!-- Exclude Patterns -->
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="text-xs font-medium text-gray-600 dark:text-gray-400">Exclude Patterns (blacklist)</label>
                        <button type="button" id="add-adv-exclude-pattern-edit" class="btn-secondary text-xs">Add Exclude Pattern</button>
                    </div>
                    <div id="adv-exclude-patterns-container-edit" class="space-y-2">
                        {{if .Content.Destination.AdvancedFilters}}
                        {{range .Content.Destination.AdvancedFilters.ExcludePatterns}}
                        <div class="adv-pattern-row flex items-center gap-2">
                            <input type="text" name="advanced_exclude_patterns[]" value="{{.}}" placeholder="Regex pattern (e.g., /sample/)"
                                class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                            <button type="button" class="remove-adv-pattern text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        {{end}}
                        {{end}}
                    </div>
                </div>
            </div>

            <!-- Remote Destinations -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Remote Destinations</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">First remote is primary, others are failover. Drag to reorder.</p>
                    </div>
                    {{if .Content.Remotes}}
                    <button type="button" id="add-remote-mapping" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 shadow-sm text-xs font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Add Remote
                    </button>
                    {{end}}
                </div>
                <div id="remote-mappings-container" class="space-y-3">
                    {{range $idx, $remote := .Content.Destination.Remotes}}
                    <div class="remote-mapping-row flex items-center gap-3" data-remote-id="{{$remote.RemoteID}}">
                        <svg class="w-4 h-4 text-gray-400 cursor-move handle flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                        <div class="w-48 flex-shrink-0">
                            <select name="remote_ids[]" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                                {{range $.Content.Remotes}}
                                <option value="{{.ID}}" {{if eq .ID $remote.RemoteID}}selected{{end}}>{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                        <span class="text-gray-500 dark:text-gray-400 flex-shrink-0"></span>
                        <div class="flex-1">
                            <input type="text" name="remote_paths[]" value="{{$remote.RemotePath}}" placeholder="Remote path (e.g., /Media/TV)"
                                class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        </div>
                        <button type="button" class="remove-remote-mapping text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {{end}}
                </div>
                {{if not .Content.Remotes}}
                <p class="text-sm text-gray-500 dark:text-gray-400">No remotes configured. <a href="/uploads/remotes/new" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create one first</a>.</p>
                {{end}}
            </div>

            <!-- Included Triggers -->
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <div class="mb-4">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Allowed Triggers</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Only files from selected local triggers (inotify/polling) will be uploaded to this destination. At least one must be selected.</p>
                </div>
                {{if .Content.LocalTriggers}}
                <div class="space-y-2">
                    {{range .Content.LocalTriggers}}
                    <label class="flex items-center">
                        <input type="checkbox" name="included_triggers[]" value="{{.ID}}" {{if $.Content.Destination.ShouldAllowTrigger .ID}}checked{{end}} class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <span class="ml-2 text-sm text-gray-900 dark:text-gray-300">{{.Name}}</span>
                        <span class="ml-2 text-xs px-1.5 py-0.5 rounded {{if eq .Type "inotify"}}bg-teal-100 text-teal-800 dark:bg-teal-900/50 dark:text-teal-400{{else}}bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-400{{end}}">{{.Type}}</span>
                    </label>
                    {{end}}
                </div>
                {{else}}
                <p class="text-sm text-gray-500 dark:text-gray-400">No local triggers configured. <a href="/triggers" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400">Create one first</a>.</p>
                {{end}}
            </div>

            <div class="flex justify-end space-x-3 pt-4">
                <a href="/uploads/destinations" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Cancel</a>
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 {{if not .Content.HasLocalTriggers}}opacity-50 cursor-not-allowed{{end}}" {{if not .Content.HasLocalTriggers}}disabled{{end}}>Update Destination</button>
            </div>
        </form>
    </div>
    <script>
    (function() {
        const existingDestinationPaths = [
            {{range .Content.Destinations}}"{{jsEscape .LocalPath}}",{{end}}
        ];
        const currentDestinationPath = "{{jsEscape .Content.Destination.LocalPath}}";
        const localPathInput = document.getElementById('local_path');
        const localPathError = document.getElementById('local_path_error_edit');

        function normalizePath(value) {
            if (!value) return '';
            let normalized = value.trim().replace(/\\/g, '/');
            if (normalized.length > 1) {
                normalized = normalized.replace(/\/+$/, '');
            }
            return normalized;
        }

        const normalizedExistingPaths = existingDestinationPaths.map(normalizePath);
        const normalizedCurrentPath = normalizePath(currentDestinationPath);

        function isDuplicatePath(value) {
            const normalized = normalizePath(value);
            if (!normalized) return false;
            if (normalizedCurrentPath && normalized === normalizedCurrentPath) {
                return false;
            }
            return normalizedExistingPaths.includes(normalized);
        }

        function updateLocalPathWarning() {
            if (!localPathInput || !localPathError) return true;
            const duplicate = isDuplicatePath(localPathInput.value);
            localPathError.classList.toggle('hidden', !duplicate);
            return !duplicate;
        }

        if (localPathInput) {
            localPathInput.addEventListener('input', updateLocalPathWarning);
            localPathInput.addEventListener('blur', updateLocalPathWarning);
        }

        const plexToggle = document.getElementById('use_plex_scan_tracking_edit');
        const plexPanel = document.getElementById('plex-tracking-panel-edit');
        const plexWarning = document.getElementById('plex-concurrency-warning-edit');
        const maxConcurrentScans = parseInt('{{.Content.ProcessorMaxConcurrentScans}}', 10) || 0;

        function updatePlexRows() {
            const rows = document.querySelectorAll('[data-plex-target-row]');
            rows.forEach((row) => {
                const checkbox = row.querySelector('input[name="plex_target_ids[]"]');
                const idleInput = row.querySelector('[data-plex-idle]');
                if (!checkbox || !idleInput) return;
                const enabled = plexToggle && plexToggle.checked && checkbox.checked;
                idleInput.disabled = !enabled;
                idleInput.classList.toggle('opacity-50', !enabled);
            });
        }

        function updatePlexPanel() {
            if (!plexToggle || !plexPanel) return;
            const enabled = plexToggle.checked;
            plexPanel.classList.toggle('hidden', !enabled);
            if (plexWarning) {
                const showWarning = enabled && (maxConcurrentScans === 0 || maxConcurrentScans >= 4);
                plexWarning.classList.toggle('hidden', !showWarning);
            }
            updatePlexRows();
        }

        if (plexToggle) {
            plexToggle.addEventListener('change', updatePlexPanel);
            document.querySelectorAll('input[name="plex_target_ids[]"]').forEach((checkbox) => {
                checkbox.addEventListener('change', updatePlexRows);
            });
            updatePlexPanel();
        }

        // Exclude paths management
        const excludePathsContainer = document.getElementById('exclude-paths-container-edit');
        const addExcludePathBtn = document.getElementById('add-exclude-path-edit');

        function createExcludePathRow(path = '') {
            const row = document.createElement('div');
            row.className = 'exclude-path-row flex items-center gap-3';
            row.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="exclude_paths[]" value="${path}" placeholder="Path prefix to exclude (e.g., /mnt/media/temp)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-exclude-path text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addExcludePathBtn) {
            addExcludePathBtn.addEventListener('click', function() {
                excludePathsContainer.appendChild(createExcludePathRow());
            });
        }

        if (excludePathsContainer) {
            excludePathsContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-exclude-path')) {
                    e.target.closest('.exclude-path-row').remove();
                }
            });
        }

        // Exclude extensions management
        const excludeExtContainer = document.getElementById('exclude-extensions-container-edit');
        const addExcludeExtBtn = document.getElementById('add-exclude-extension-edit');

        function createExcludeExtRow(ext = '') {
            const row = document.createElement('div');
            row.className = 'exclude-ext-row flex items-center gap-3';
            row.innerHTML = `
                <div class="flex-1">
                    <input type="text" name="exclude_extensions[]" value="${ext}" placeholder="Extension to exclude (e.g., .tmp)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-exclude-ext text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addExcludeExtBtn) {
            addExcludeExtBtn.addEventListener('click', function() {
                excludeExtContainer.appendChild(createExcludeExtRow());
            });
        }

        if (excludeExtContainer) {
            excludeExtContainer.addEventListener('click', function(e) {
                if (e.target.closest('.remove-exclude-ext')) {
                    e.target.closest('.exclude-ext-row').remove();
                }
            });
        }

        // Advanced filters management (edit destination form)
        function createAdvPatternRowEdit(name, value = '') {
            const row = document.createElement('div');
            row.className = 'adv-pattern-row flex items-center gap-2';
            row.innerHTML = `
                <input type="text" name="${name}" value="${value}" placeholder="Regex pattern (e.g., \\.mkv$)"
                    class="flex-1 rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-1.5 border">
                <button type="button" class="remove-adv-pattern text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            return row;
        }

        const advIncludeContainerEdit = document.getElementById('adv-include-patterns-container-edit');
        const advExcludeContainerEdit = document.getElementById('adv-exclude-patterns-container-edit');
        const addAdvIncludeBtnEdit = document.getElementById('add-adv-include-pattern-edit');
        const addAdvExcludeBtnEdit = document.getElementById('add-adv-exclude-pattern-edit');

        if (addAdvIncludeBtnEdit && advIncludeContainerEdit) {
            addAdvIncludeBtnEdit.addEventListener('click', function() {
                advIncludeContainerEdit.appendChild(createAdvPatternRowEdit('advanced_include_patterns[]'));
            });
        }

        if (addAdvExcludeBtnEdit && advExcludeContainerEdit) {
            addAdvExcludeBtnEdit.addEventListener('click', function() {
                advExcludeContainerEdit.appendChild(createAdvPatternRowEdit('advanced_exclude_patterns[]'));
            });
        }

        // Remove pattern handlers (edit form)
        [advIncludeContainerEdit, advExcludeContainerEdit].forEach(cont => {
            if (cont) {
                cont.addEventListener('click', function(e) {
                    if (e.target.closest('.remove-adv-pattern')) {
                        e.target.closest('.adv-pattern-row').remove();
                    }
                });
            }
        });

        // Remote destinations management
        const remotesData = [
            {{range .Content.Remotes}}
            { id: {{.ID}}, name: "{{.Name}}" },
            {{end}}
        ];

        const container = document.getElementById('remote-mappings-container');
        const addBtn = document.getElementById('add-remote-mapping');

        function createRemoteMappingRow(remoteId = '', remotePath = '') {
            const row = document.createElement('div');
            row.className = 'remote-mapping-row flex items-center gap-3';

            const optionsHtml = remotesData.map(r =>
                `<option value="${r.id}" ${r.id == remoteId ? 'selected' : ''}>${r.name}</option>`
            ).join('');

            row.innerHTML = `
                <svg class="w-4 h-4 text-gray-400 cursor-move handle flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                <div class="w-48 flex-shrink-0">
                    <select name="remote_ids[]" class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                        ${optionsHtml}
                    </select>
                </div>
                <span class="text-gray-500 dark:text-gray-400 flex-shrink-0"></span>
                <div class="flex-1">
                    <input type="text" name="remote_paths[]" value="${remotePath}" placeholder="Remote path (e.g., /Media/TV)"
                        class="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border">
                </div>
                <button type="button" class="remove-remote-mapping text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 flex-shrink-0">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            return row;
        }

        if (addBtn) {
            addBtn.addEventListener('click', function() {
                container.appendChild(createRemoteMappingRow());
            });
        }

        if (container) {
            container.addEventListener('click', function(e) {
                if (e.target.closest('.remove-remote-mapping')) {
                    e.target.closest('.remote-mapping-row').remove();
                }
            });

            // Initialize sortable for drag-and-drop reordering
            new Sortable(container, {
                animation: 150,
                handle: '.handle'
            });
        }

        const hasLocalTriggers = {{if .Content.HasLocalTriggers}}true{{else}}false{{end}};

        // Form validation
        const form = document.getElementById('edit-destination-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                const remoteSelects = form.querySelectorAll('select[name="remote_ids[]"]');
                const triggerCheckboxes = form.querySelectorAll('input[name="included_triggers[]"]:checked');
                const plexSelected = form.querySelectorAll('input[name="plex_target_ids[]"]:checked');

                const errors = [];
                if (!hasLocalTriggers) {
                    errors.push('At least one local trigger is required before configuring uploads');
                }
                if (!updateLocalPathWarning()) {
                    errors.push('Local path must be unique');
                }
                if (remoteSelects.length === 0) {
                    errors.push('At least one remote must be configured');
                }
                if (triggerCheckboxes.length === 0) {
                    errors.push('At least one trigger must be selected');
                }
                if (plexToggle && plexToggle.checked) {
                    if (plexSelected.length === 0) {
                        errors.push('Select at least one Plex target for scan tracking');
                    }
                    plexSelected.forEach((checkbox) => {
                        const idleInput = form.querySelector('input[name="plex_idle_threshold_' + checkbox.value + '"]');
                        const idleValue = idleInput ? parseInt(idleInput.value, 10) : 0;
                        if (!idleValue || idleValue <= 0) {
                            const targetName = checkbox.dataset.plexName || checkbox.value;
                            errors.push('Idle threshold must be greater than 0 for Plex target: ' + targetName);
                        }
                    });
                }

                if (errors.length > 0) {
                    e.preventDefault();
                    showAlertModal('error', 'Validation Error', errors);
                }
            });
        }
    })();
    </script>
    {{else}}
    <!-- Destinations List -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Destinations</h3>
            {{if .Content.HasLocalTriggers}}
            <a href="/uploads/destinations/new" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Add Destination</a>
            {{else}}
            <span class="text-sm text-gray-500 dark:text-gray-400">Add a local trigger to enable destinations</span>
            {{end}}
        </div>
        <div class="overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Local Path</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Delay</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Remotes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                        <th class="relative px-6 py-3">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {{if .Content.Destinations}}
                    {{range .Content.Destinations}}
                    <tr id="destination-{{.ID}}">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-white">
                            <div class="break-all" title="{{.LocalPath}}">{{.LocalPath}}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{if .UsePlexTracking}}
                                Plex tracking ({{len .PlexTargets}} targets)
                            {{else if and (gt .MinFileAgeMinutes 0) (gt .MinFolderSizeGB 0)}}
                                Age {{.MinFileAgeMinutes}}m + Size {{.MinFolderSizeGB}}GB
                            {{else if gt .MinFileAgeMinutes 0}}
                                Age {{.MinFileAgeMinutes}}m
                            {{else if gt .MinFolderSizeGB 0}}
                                Size {{.MinFolderSizeGB}}GB
                            {{else}}
                                Immediate
                            {{end}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            {{len .Remotes}} configured
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {{if .Enabled}}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Enabled</span>
                            {{else}}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Disabled</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <div class="flex justify-end gap-2">
                                <a href="/uploads/destinations/{{.ID}}" class="btn-primary text-sm">Edit</a>
                                <button hx-delete="/uploads/destinations/{{.ID}}" hx-target="#destination-{{.ID}}" hx-swap="outerHTML" hx-confirm="Are you sure you want to delete this destination?" class="btn-danger text-sm">Delete</button>
                            </div>
                        </td>
                    </tr>
                    {{end}}
                    {{else}}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-center">
                            {{if .Content.HasLocalTriggers}}
                                No destinations configured. <a href="/uploads/destinations/new" class="text-indigo-600 hover:text-indigo-900">Add one</a>
                            {{else}}
                                No destinations configured. Create a local trigger first.
                            {{end}}
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
    </div>
    {{end}}
    {{end}}
</div>

<script>
// Track currently shown backend panel
let currentBackend = null;

function showBackendPanel(backend) {
    // Hide any currently visible panel
    if (currentBackend) {
        const oldPanel = document.getElementById('backend-panel-' + currentBackend);
        if (oldPanel) oldPanel.classList.add('hidden');
    }

    // Show the new panel if a backend was selected
    if (backend) {
        const newPanel = document.getElementById('backend-panel-' + backend);
        if (newPanel) newPanel.classList.remove('hidden');
        currentBackend = backend;
    } else {
        currentBackend = null;
    }
}

function hideBackendPanel() {
    if (currentBackend) {
        const panel = document.getElementById('backend-panel-' + currentBackend);
        if (panel) panel.classList.add('hidden');
    }
    currentBackend = null;
    // Reset select
    const select = document.querySelector('select[onchange="showBackendPanel(this.value)"]');
    if (select) select.value = '';
}

function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

const sizeOptions = [
    { value: '256K', bytes: 262144, label: '256K' },
    { value: '512K', bytes: 524288, label: '512K' },
    { value: '1M', bytes: 1048576, label: '1M' },
    { value: '2M', bytes: 2097152, label: '2M' },
    { value: '4M', bytes: 4194304, label: '4M' },
    { value: '8M', bytes: 8388608, label: '8M' },
    { value: '16M', bytes: 16777216, label: '16M' },
    { value: '32M', bytes: 33554432, label: '32M' },
    { value: '64M', bytes: 67108864, label: '64M' },
    { value: '128M', bytes: 134217728, label: '128M' },
    { value: '256M', bytes: 268435456, label: '256M' },
    { value: '512M', bytes: 536870912, label: '512M' },
    { value: '1G', bytes: 1073741824, label: '1G' }
];

function isSizeOption(optType, optName) {
    if (optType === 'SizeSuffix') return true;
    const name = String(optName || '').toLowerCase();
    return /(?:chunk|buffer|block|part).*size/.test(name);
}

function parseSizeToBytes(value) {
    if (value === null || value === undefined) return null;
    const raw = String(value).trim();
    if (raw === '') return null;
    const numeric = Number(raw);
    if (Number.isFinite(numeric)) {
        return Math.round(numeric);
    }
    const match = raw.match(/^(\d+(?:\.\d+)?)([KMGTP]?)(?:i?B)?$/i);
    if (!match) return null;
    const num = Number(match[1]);
    if (!Number.isFinite(num)) return null;
    const suffix = (match[2] || '').toUpperCase();
    const multipliers = {
        '': 1,
        K: 1024,
        M: 1024 * 1024,
        G: 1024 * 1024 * 1024,
        T: 1024 * 1024 * 1024 * 1024,
        P: 1024 * 1024 * 1024 * 1024 * 1024
    };
    const multiplier = multipliers[suffix] || 1;
    return Math.round(num * multiplier);
}

function formatSizeLabel(bytes) {
    const value = Number(bytes);
    if (!Number.isFinite(value)) return String(bytes);
    const units = ['B', 'K', 'M', 'G', 'T'];
    let unitIndex = 0;
    let scaled = value;
    while (scaled >= 1024 && unitIndex < units.length - 1) {
        scaled /= 1024;
        unitIndex++;
    }
    const formatted = scaled % 1 === 0 ? String(scaled) : scaled.toFixed(1);
    return `${formatted}${units[unitIndex]}`;
}

function buildSizeOptionsHtml(selectedValue) {
    const selectedBytes = parseSizeToBytes(selectedValue);
    const selectedStr = selectedValue === null || selectedValue === undefined ? null : String(selectedValue).trim();
    const options = [];
    if (selectedBytes === null) {
        options.push('<option value="" selected>Select size...</option>');
    }
    let matched = false;
    sizeOptions.forEach(opt => {
        const selected = selectedBytes !== null && selectedBytes === opt.bytes ? ' selected' : '';
        if (selected) matched = true;
        options.push(`<option value="${opt.value}"${selected}>${opt.label}</option>`);
    });
    if (selectedStr) {
        if (!matched) {
            const label = selectedBytes === null ? selectedStr : formatSizeLabel(selectedBytes);
            options.unshift(`<option value="${selectedStr}" selected>Current (${label})</option>`);
        }
    }
    return options.join('');
}

function upgradeExistingSizeOptions() {
    const container = document.getElementById('configured-options');
    if (!container) return;
    const inputs = container.querySelectorAll('input[type="text"][name^="opt_"]');
    inputs.forEach(input => {
        const optName = input.name.replace(/^opt_/, '');
        if (!isSizeOption('', optName)) return;
        const select = document.createElement('select');
        select.name = input.name;
        select.className = input.className;
        select.innerHTML = buildSizeOptionsHtml(input.value);
        input.replaceWith(select);
    });
}

function getOrCreateBackendGroup(backend) {
    const container = document.getElementById('configured-options');
    const safeBackend = escapeHtml(backend);
    let group = document.getElementById('opt-group-' + safeBackend);

    if (!group) {
        group = document.createElement('div');
        group.id = 'opt-group-' + safeBackend;
        group.className = 'border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden';
        group.innerHTML = `
            <div class="bg-gray-100 dark:bg-gray-700 px-3 py-2 flex justify-between items-center">
                <h5 class="text-sm font-medium text-gray-900 dark:text-white">${safeBackend === '_global' ? 'Global' : safeBackend} Options</h5>
                <button type="button" onclick="removeBackendGroup('${safeBackend}')" class="text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400 text-xs">Remove All</button>
            </div>
            <div class="p-3 space-y-3" id="opt-group-content-${safeBackend}"></div>
        `;
        container.appendChild(group);
    }

    return document.getElementById('opt-group-content-' + safeBackend);
}

function addOption(backend, optName, optDefault, optHelp, optType, choicesJson) {
    // Check if option already exists
    if (document.querySelector('[name="opt_' + optName + '"]')) {
        showAlertModal('warning', 'Option Already Configured', 'Option "' + escapeHtml(optName) + '" is already configured.');
        return;
    }

    const groupContent = getOrCreateBackendGroup(backend);
    const div = document.createElement('div');
    div.className = 'bg-white dark:bg-gray-600 p-3 rounded shadow-sm space-y-2';
    div.id = 'opt-row-' + escapeHtml(optName);

    const defaultVal = optDefault !== null && optDefault !== undefined ? String(optDefault) : '';
    const safeName = escapeHtml(optName);
    const safeDefault = escapeHtml(defaultVal);
    // Convert \n to <br> for proper line breaks in help text
    // Convert markdown links [text](url) to clickable links (relative paths go to rclone.org)
    // Convert direct URLs like https://... to clickable links
    const safeHelp = escapeHtml(optHelp || '')
        .replace(/\\n/g, '<br>')
        .replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" class="text-indigo-600 dark:text-indigo-400 underline">$1</a>')
        .replace(/\[([^\]]+)\]\(\/([^)]+)\)/g, '<a href="https://rclone.org/$2" target="_blank" class="text-indigo-600 dark:text-indigo-400 underline">$1</a>')
        .replace(/(?<![">])(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" class="text-indigo-600 dark:text-indigo-400 underline">$1</a>');
    const safeType = escapeHtml(optType || 'string');

    // Parse choices if provided
    let choices = null;
    if (choicesJson && choicesJson !== '') {
        try {
            choices = JSON.parse(choicesJson);
        } catch (e) {
            console.warn('Failed to parse choices for option', optName, e);
        }
    }

    // Build the input element - use select for limited choices, text input otherwise
    let inputHtml;
    if (optType === 'Encoding' && choices && choices.length > 0) {
        // Use checkbox list + editable text field for Encoding
        const defaultFlags = defaultVal ? defaultVal.split(',').map(s => s.trim()).filter(s => s) : [];
        const checkboxes = choices.map(c => {
            const checked = defaultFlags.includes(c) ? ' checked' : '';
            return `<label class="flex items-center gap-1.5 text-xs text-gray-700 dark:text-gray-300"><input type="checkbox" value="${escapeHtml(c)}"${checked} onchange="updateEncodingFromCheckboxes('${safeName}')" class="rounded border-gray-300 dark:border-gray-500 text-indigo-600 focus:ring-indigo-500">${escapeHtml(c)}</label>`;
        }).join('');
        inputHtml = `
            <input type="text" name="opt_${safeName}" id="opt-input-${safeName}" value="${safeDefault}" oninput="updateEncodingCheckboxes('${safeName}')" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-500 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1.5 border mb-2">
            <div id="opt-checkboxes-${safeName}" class="grid grid-cols-3 gap-1 p-2 bg-gray-50 dark:bg-gray-700 rounded max-h-32 overflow-y-auto">${checkboxes}</div>`;
    } else if (isSizeOption(optType, optName)) {
        const optionsHtml = buildSizeOptionsHtml(defaultVal);
        inputHtml = `<select name="opt_${safeName}" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-500 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1.5 border">${optionsHtml}</select>`;
    } else if (choices && choices.length > 0) {
        // Use a dropdown for types with limited choices
        const options = choices.map(c => {
            const selected = c === defaultVal ? ' selected' : '';
            return `<option value="${escapeHtml(c)}"${selected}>${escapeHtml(c)}</option>`;
        }).join('');
        inputHtml = `<select name="opt_${safeName}" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-500 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1.5 border">${options}</select>`;
    } else {
        // Use text input for free-form values
        inputHtml = `<input type="text" name="opt_${safeName}" value="${safeDefault}" placeholder="${safeDefault}" class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-500 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-2 py-1.5 border">`;
    }

    div.innerHTML = `
        <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">${safeName}</label>
            <button type="button" onclick="removeOption('${safeName}', '${escapeHtml(backend)}')" class="text-red-600 hover:text-red-800 dark:text-red-400 text-xs">Remove</button>
        </div>
        <input type="hidden" name="opt_type_${safeName}" value="${safeType}">
        ${inputHtml}
        <p class="text-xs text-gray-500 dark:text-gray-400">${safeHelp}</p>
    `;

    groupContent.appendChild(div);

    // Focus the new input/select
    const focusEl = div.querySelector('input[type="text"], select');
    if (focusEl) focusEl.focus();
}

function removeOption(optName, backend) {
    const row = document.getElementById('opt-row-' + escapeHtml(optName));
    if (row) row.remove();

    // Remove the group if empty
    if (backend) {
        const groupContent = document.getElementById('opt-group-content-' + escapeHtml(backend));
        if (groupContent && groupContent.children.length === 0) {
            const group = document.getElementById('opt-group-' + escapeHtml(backend));
            if (group) group.remove();
        }
    }
}

function removeBackendGroup(backend) {
    const group = document.getElementById('opt-group-' + escapeHtml(backend));
    if (group) group.remove();
}

function removeBackendPanel(backend) {
    hideBackendPanel();
}

function updateEncodingFromCheckboxes(optName) {
    const container = document.getElementById('opt-checkboxes-' + optName);
    const input = document.getElementById('opt-input-' + optName);
    if (container && input) {
        const checked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        input.value = checked.join(',');
    }
}

function updateEncodingCheckboxes(optName) {
    const container = document.getElementById('opt-checkboxes-' + optName);
    const input = document.getElementById('opt-input-' + optName);
    if (container && input) {
        const flags = input.value.split(',').map(s => s.trim()).filter(s => s);
        container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = flags.includes(cb.value);
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    upgradeExistingSizeOptions();
});
</script>
{{end}}

{{define "upload_queue"}}
{{if .}}
{{range .}}
<tr id="upload-{{.ID}}" {{if .WaitState}}data-wait-state="{{.WaitState}}"{{end}} {{if .WaitChecks}}data-wait-checks="{{.WaitChecks}}"{{end}}>
    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">
        <div class="break-all" title="{{.LocalPath}}">{{.LocalPath}}</div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{.RemoteName}}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm">
        {{if eq .Status "uploading"}}
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">Uploading</span>
        {{else if eq .Status "queued"}}
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Queued</span>
        {{else if eq .Status "pending"}}
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200">Pending</span>
        {{if .WaitState}}
        <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            {{if eq .WaitState "waiting_age"}}Waiting for file age
            {{else if eq .WaitState "waiting_size"}}Waiting for folder size
            {{else if eq .WaitState "waiting_plex"}}Waiting for Plex scan
            {{else if eq .WaitState "waiting_config"}}Waiting for configuration
            {{else if eq .WaitState "ready"}}Ready
            {{else}}{{.WaitState}}{{end}}
        </div>
        {{end}}
        {{else if eq .Status "completed"}}
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Completed</span>
        {{else if eq .Status "failed"}}
        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Failed</span>
        {{end}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
        {{if .SizeBytes}}{{formatBytes .SizeBytes}}{{else}}-{{end}}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
        {{if eq .Status "failed"}}
        <div class="flex justify-end gap-2">
            <button type="button" hx-post="/uploads/{{.ID}}/retry" hx-swap="none" class="btn-primary text-sm">Retry</button>
            <button type="button" hx-post="/uploads/{{.ID}}/cancel" hx-target="#upload-{{.ID}}" hx-swap="outerHTML" hx-confirm="Clear this failed upload entry?" class="btn-danger text-sm">Clear</button>
        </div>
        {{end}}
    </td>
</tr>
{{end}}
{{else}}
<tr>
    <td colspan="5" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 text-center">
        No uploads in queue
    </td>
</tr>
{{end}}
{{end}}

{{define "active_transfers"}}
<div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
    <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white">Active Transfers</h3>
        {{if and . .Transfers}}
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            {{formatBytes .Stats.Bytes}} / {{formatBytes .Stats.TotalBytes}} at {{formatSpeed .Stats.Speed}}/s
            {{if .Stats.ETA}} | ETA: {{formatETA .Stats.ETA}}{{end}}
        </p>
        {{else}}
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">No active transfers</p>
        {{end}}
    </div>
    {{if and . .Transfers}}
    <div class="p-4 space-y-3">
        {{range .Transfers}}
        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
            <!-- Row 1: Filename and ETA -->
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-900 dark:text-white truncate flex-1 mr-4" title="{{.Name}}">
                    {{.Name}}
                </span>
                <span class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap">{{if .ETA}}{{formatETA .ETA}}{{else}}-{{end}}</span>
            </div>
            <!-- Row 2: Progress bar (full width) -->
            <div class="bg-gray-200 dark:bg-gray-600 rounded-full h-2.5 mb-2">
                <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: {{.Percentage}}%"></div>
            </div>
            <!-- Row 3: Size, Percentage (centered), Speed -->
            <div class="flex items-center justify-between text-xs text-gray-500 dark:text-gray-400">
                <span class="flex-1">{{formatBytes .Bytes}} / {{formatBytes .Size}}</span>
                <span class="flex-1 text-center w-12">{{.Percentage}}%</span>
                <span class="flex-1 text-right">{{formatSpeed .Speed}}/s</span>
            </div>
        </div>
        {{end}}
    </div>
    {{end}}
</div>
{{end}}

{{define "upload_queue_stats"}}Active: {{.ActiveCount}} | Queued: {{.QueuedCount}} | Pending: {{.PendingCount}}{{end}}

{{define "upload_queue_pagination"}}
{{if gt .TotalCount 0}}
<div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
    <div class="flex items-center gap-4">
        <span class="text-sm text-gray-700 dark:text-gray-300">
            Showing {{if gt .TotalCount 0}}{{add (mul (sub .Page 1) .PageSize) 1}}{{else}}0{{end}} to {{min (mul .Page .PageSize) .TotalCount}} of {{.TotalCount}} uploads
        </span>
        <div class="flex items-center gap-2">
            <label for="pageSize" class="text-sm text-gray-700 dark:text-gray-300">Per page:</label>
            <select id="pageSize" onchange="window.location.href='/uploads?page=1&pageSize=' + this.value" class="rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-1 px-2 border">
                <option value="10" {{if eq .PageSize 10}}selected{{end}}>10</option>
                <option value="20" {{if eq .PageSize 20}}selected{{end}}>20</option>
                <option value="50" {{if eq .PageSize 50}}selected{{end}}>50</option>
                <option value="100" {{if eq .PageSize 100}}selected{{end}}>100</option>
            </select>
        </div>
    </div>
    <div class="flex items-center gap-2">
        {{if gt .Page 1}}
        <a href="/uploads?page={{sub .Page 1}}&pageSize={{.PageSize}}" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            Previous
        </a>
        {{else}}
        <span class="inline-flex items-center px-3 py-2 border border-gray-200 dark:border-gray-700 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-800 cursor-not-allowed">
            Previous
        </span>
        {{end}}
        <span class="text-sm text-gray-700 dark:text-gray-300">
            Page {{.Page}} of {{.TotalPages}}
        </span>
        {{if lt .Page .TotalPages}}
        <a href="/uploads?page={{add .Page 1}}&pageSize={{.PageSize}}" class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            Next
        </a>
        {{else}}
        <span class="inline-flex items-center px-3 py-2 border border-gray-200 dark:border-gray-700 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-400 dark:text-gray-500 bg-gray-100 dark:bg-gray-800 cursor-not-allowed">
            Next
        </span>
        {{end}}
    </div>
</div>
{{end}}
{{end}}

{{template "base" .}}
